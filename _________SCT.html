<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DefectDojo Engagements</title>
    <style>
        /* Enhanced Bootstrap-inspired CSS */
        :root {
            --bs-blue: #0d6efd;
            --bs-success: #28a745;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-gray-100: #f8f9fa;
            --bs-gray-200: #e9ecef;
            --bs-dark: #2c3e50;
            --bs-light: #ffffff;
            --highlight-green: #d4edda; /* Light green for highlight */
        }
        body {
            background: linear-gradient(135deg, #6e48aa 0%, #9d50bb 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            background: var(--bs-light);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90vw;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        h1, h2 {
            color: var(--bs-dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .row { display: flex; flex-wrap: wrap; gap: 15px; }
        .col-md-3, .col-md-2 { flex: 1; min-width: 150px; }
        .col-md-2-4 { flex: 0 0 20%; min-width: 120px; } /* Adjusted for 5 filters */
        .text-end { text-align: end; }
        .w-100 { width: 100%; }

        .form-control, .form-select, .version-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 8px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            background: #f0f4f8;
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
            background: #fff;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--bs-blue), #5a9bff);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #95a5a6);
            color: white;
        }
        .btn-success {
            background: linear-gradient(45deg, var(--bs-success), #5cb85c);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(45deg, var(--bs-danger), #ff6b6b);
            color: white;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        .btn-refresh, .btn-clear {
            padding: 6px 12px; /* Match btn-sm size */
            font-size: 0.875rem;
        }
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .alert {
            position: absolute;
            right: 25px;
            top: 150px;
            padding: 8px 15px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
            max-width: 200px;
            font-size: 0.9rem;
        }
        .alert-success {
            background: linear-gradient(45deg, #d4edda, #e6f7e9);
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-danger {
            background: linear-gradient(45deg, #f8d7da, #fce4e6);
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .large-modal {
            max-width: 95%;
            width: 95%;
            max-height: 85vh;
        }
        #testCasesModal {
            z-index: 1001; /* Higher z-index to appear on top of analystViewModal */
        }

        /* Tab Styles */
        .tab-container {
            display: flex;
            border-bottom: 2px solid var(--bs-gray-200);
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            background: var(--bs-gray-100);
            color: var(--bs-dark);
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #e0e0e0;
        }
        .tab.active {
            background: var(--bs-blue);
            color: white;
        }
        .tab-content {
            display: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
        }
        th {
            background: linear-gradient(45deg, var(--bs-gray-200), #f1f3f5);
            color: var(--bs-dark);
            font-weight: 600;
            white-space: normal;
            word-wrap: break-word;
        }
        td {
            background: #fafafa;
            transition: background 0.2s;
        }
        tr:hover td {
            background: #f0f4f8;
        }
        .highlight-name {
            background: var(--highlight-green) !important;
        }
        .clickable {
            cursor: pointer;
            text-decoration: underline;
            color: var(--bs-blue);
        }
        .clickable:hover {
            color: #0056b3;
        }
        /* Adjust column widths */
        th:nth-child(1), td:nth-child(1) { min-width: 100px; } /* Created */
        th:nth-child(2), td:nth-child(2) { min-width: 150px; } /* Name */
        th:nth-child(3), td:nth-child(3) { min-width: 60px; } /* Total Key */
        th:nth-child(4), td:nth-child(4) { min-width: 60px; } /* Completed */
        th:nth-child(5), td:nth-child(5) { min-width: 50px; } /* Pending (Reduced from 60px) */
        th:nth-child(6), td:nth-child(6) { min-width: 60px; } /* On Hold */
        th:nth-child(7), td:nth-child(7) { min-width: 60px; } /* Rejected */
        th:nth-child(8), td:nth-child(8) { min-width: 60px; } /* Doable Jira */
        th:nth-child(9), td:nth-child(9) { min-width: 60px; } /* Non-Doable Jira */
        th:nth-child(10), td:nth-child(10) { min-width: 120px; } /* Status (Analyst) */
        th:nth-child(11), td:nth-child(11) { min-width: 120px; } /* Status (Mentor) */
        th:nth-child(12), td:nth-child(12) { min-width: 120px; } /* Status (Lead) */
        th:nth-child(13), td:nth-child(13) { min-width: 150px; } /* Lead */
        th:nth-child(14), td:nth-child(14) { min-width: 120px; } /* Version */
        th:nth-child(15), td:nth-child(15) { min-width: 120px; } /* Action */
        /* Test Cases Modal Table Column Widths */
        #testCasesTable th:nth-child(1), #testCasesTable td:nth-child(1) { min-width: 50px; } /* ID */
        #testCasesTable th:nth-child(2), #testCasesTable td:nth-child(2) { min-width: 150px; } /* Title */
        #testCasesTable th:nth-child(3), #testCasesTable td:nth-child(3) { min-width: 200px; } /* Description */
        #testCasesTable th:nth-child(4), #testCasesTable td:nth-child(4) { min-width: 100px; } /* Version */
        #testCasesTable th:nth-child(5), #testCasesTable td:nth-child(5) { min-width: 100px; } /* Status */
        #testCasesTable th:nth-child(6), #testCasesTable td:nth-child(6) { min-width: 150px; } /* Assigned To */
        #testCasesTable th:nth-child(7), #testCasesTable td:nth-child(7) { min-width: 100px; } /* Type */
        #testCasesTable th:nth-child(8), #testCasesTable td:nth-child(8) { min-width: 100px; } /* Issue Type */
        #testCasesTable th:nth-child(9), #testCasesTable td:nth-child(9) { min-width: 100px; } /* Jira Status */
        /* Analyst View Table Column Widths */
        #analystTable th:nth-child(1), #analystTable td:nth-child(1) { min-width: 150px; } /* Assigned To */
        #analystTable th:nth-child(2), #analystTable td:nth-child(2) { min-width: 100px; } /* Type */
        #analystTable th:nth-child(3), #analystTable td:nth-child(3) { min-width: 100px; } /* Version */
        #analystTable th:nth-child(4), #analystTable td:nth-child(4) { min-width: 60px; } /* Pending */
        #analystTable th:nth-child(5), #analystTable td:nth-child(5) { min-width: 60px; } /* On Hold */
        #analystTable th:nth-child(6), #analystTable td:nth-child(6) { min-width: 60px; } /* Completed */
        #analystTable th:nth-child(7), #analystTable td:nth-child(7) { min-width: 60px; } /* Rejected */
        #analystTable th:nth-child(8), #analystTable td:nth-child(8) { min-width: 60px; } /* Doable */
        #analystTable th:nth-child(9), #analystTable td:nth-child(9) { min-width: 60px; } /* Non Doable */
        .form-select {
            padding: 8px 24px 8px 8px;
            appearance: none;
            background: #f0f4f8 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="5" viewBox="0 0 10 5"><path fill="%232c3e50" d="M0 0h10L5 5z"/></svg>') no-repeat right 8px center;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-shrink: 0;
        }
        .page-item {
            padding: 8px 14px;
            background: var(--bs-gray-100);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .page-item:hover, .page-item.active {
            background: var(--bs-blue);
            color: white;
        }

        /* Invisible CSRF */
        #csrfToken, .csrf-label {
            color: #ffffff;
        }

        /* Total Count */
        .total-count {
            font-size: 1.1rem;
            color: var(--bs-dark);
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* Total Row */
        .total-row td {
            background: var(--bs-gray-100);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Engagements Dashboard</h1>

        <div class="d-flex justify-content-between mb-2">
		
		<button class="btn btn-success btn-sm" onclick="showCreateSCTModal()">Create SCT</button>  <button class="btn btn-primary btn-sm" onclick="showReassignmentModal()">Reassignment</button>
		
		
            <button class="btn btn-primary btn-refresh" onclick="fetchEngagements()" data-tooltip="Refresh">ðŸ”„</button>
			
			
            <span class="csrf-label">CSRF Token: <strong id="csrfToken">Fetching...</strong></span>
        </div>

        <div class="total-count" id="totalCount">Total Engagements: 0</div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('open')">Open SCT</div>
            <div class="tab" onclick="switchTab('closed')">Closed SCT</div>
        </div>

        <div id="open-tab" class="tab-content active">
            <div class="row mb-2">
                <!-- Filter by Jira(s) assigned -->
                <div class="col-md-3">
                    <select id="jiraAssignedFilterOpen" class="form-select" onchange="renderTableOpen(currentPageOpen)">
                        <option value="">Filter by Jira(s) assigned</option>
                    </select>
                   <div class="d-flex gap-2 flex-wrap">
    <button class="btn btn-secondary btn-sm icon-btn" data-bs-toggle="tooltip" title="View by Analyst" onclick="showAnalystView('open')">&#128100;</button> 
	<button class="btn btn-secondary btn-sm icon-btn" data-bs-toggle="tooltip" title="View Report" onclick="showReportModal()">&#128196;</button>
    <button class="btn btn-secondary btn-sm icon-btn" data-bs-toggle="tooltip" title="Total Test Counts" onclick="showTotalTestCounts()">&#128202;</button> 

    <button class="btn btn-secondary btn-sm icon-btn" data-bs-toggle="tooltip" title="View Completed Summary" onclick="showCompletedSummary('open')">&#9989;</button> 

	<button class="btn btn-primary btn-sm mt-2" onclick="showOverallSummary()">Overall Summary</button>
</div>

<style>
    .icon-btn {
        width: 40px; 
        height: 40px; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        padding: 5px;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>


                </div>
                <!-- Name Search -->
                <div class="col-md-3">
                    <input type="text" id="nameSearchOpen" class="form-control" placeholder="Search by name..." oninput="fetchEngagements()">
                </div>
                <!-- Filter by SCT assigned -->
                <div class="col-md-3">
                    <select id="leadFilterOpen" class="form-select" onchange="fetchEngagements()">
                        <option value="">Filter by SCT assigned</option>
                    </select>
                </div>
                <!-- Date Filters -->
                <div class="col-md-2">
                    <input type="date" id="date1Open" class="form-control" onchange="fetchEngagements()">
                </div>
                <div class="col-md-2">
                    <input type="date" id="date2Open" class="form-control" onchange="fetchEngagements()">
                </div>
                <!-- Clear Filters Button -->
                <div class="col-md-2 text-end">
                    <button class="btn btn-secondary btn-clear" onclick="clearFilters('open')" data-tooltip="Clear Filters">â†º</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th rowspan="2">Created</th>
                        <th rowspan="2">Name</th>
                        <th rowspan="2">Total Key</th>
                        <th colspan="4" class="text-center">Analysis Status</th>
                        <th colspan="2" class="text-center">Jira Status</th>
                        <th rowspan="2">Status (Analyst)</th>
                        <th rowspan="2">Status (Mentor)</th>
                        <th rowspan="2">Status (Lead)</th>
                        <th rowspan="2">Lead</th>
                        <th rowspan="2">Version</th>
                        <th rowspan="2">Action</th>
                    </tr>
                    <tr>
                        <th>Completed</th>
                        <th>Pending</th>
                        <th>On Hold</th>
                        <th>Rejected</th>
                        <th>Doable Jira</th>
                        <th>Non-Doable Jira</th>
                    </tr>
                </thead>
                <tbody id="engagementsTable"></tbody>
            </table>

            <div class="pagination" id="pagination"></div>
        </div>

        <div id="closed-tab" class="tab-content">
            <div class="row mb-2">
                <!-- Filter by Jira(s) assigned -->
                <div class="col-md-3">
                    <select id="jiraAssignedFilterClosed" class="form-select" onchange="renderTableClosed(currentPageClosed)">
                        <option value="">Filter by Jira(s) assigned</option>
                    </select>
                    <button class="btn btn-secondary btn-sm mt-2" onclick="showAnalystView('closed')">View by Analyst</button>
                &nbsp;&nbsp;
					<button class="btn btn-secondary btn-sm mt-2" onclick="showCompletedSummary('closed')">View Completed Summary</button>
					<button class="btn btn-secondary btn-sm mt-2" onclick="showTrendView('closed')">View Trend</button>
					
					
					
					
				</div>
                <!-- Name Search -->
                <div class="col-md-3">
                    <input type="text" id="nameSearchClosed" class="form-control" placeholder="Search by name..." oninput="fetchEngagements()">
                </div>
                <!-- Filter by SCT assigned -->
                <div class="col-md-3">
                    <select id="leadFilterClosed" class="form-select" onchange="fetchEngagements()">
                        <option value="">Filter by SCT assigned</option>
                    </select>
                </div>
                <!-- Date Filters -->
                <div class="col-md-2">
                    <input type="date" id="date1Closed" class="form-control" onchange="fetchEngagements()">
                </div>
                <div class="col-md-2">
                    <input type="date" id="date2Closed" class="form-control" onchange="fetchEngagements()">
                </div>
                <!-- Clear Filters Button -->
                <div class="col-md-2 text-end">
                    <button class="btn btn-secondary btn-clear" onclick="clearFilters('closed')" data-tooltip="Clear Filters">â†º</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th rowspan="2">Created</th>
                        <th rowspan="2">Name</th>
                        <th rowspan="2">Total Key</th>
                        <th colspan="4" class="text-center">Analysis Status</th>
                        <th colspan="2" class="text-center">Jira Status</th>
                        <th rowspan="2">Status (Analyst)</th>
                        <th rowspan="2">Status (Mentor)</th>
                        <th rowspan="2">Status (Lead)</th>
                        <th rowspan="2">Lead</th>
                        <th rowspan="2">Version</th>
                        <th rowspan="2">Action</th>
                    </tr>
                    <tr>
                        <th>Completed</th>
                        <th>Pending</th>
                        <th>On Hold</th>
                        <th>Rejected</th>
                        <th>Doable Jira</th>
                        <th>Non-Doable Jira</th>
                    </tr>
                </thead>
                <tbody id="closedEngagementsTable"></tbody>
            </table>

            <div class="pagination" id="closedPagination"></div>
        </div>

        <div id="alertBox" class="alert"></div>
        <div id="modalOverlay" class="modal-overlay"></div>
        <div id="closeModal" class="modal">
            <p id="modalContent"></p>
        </div>
        <div id="testCasesModal" class="modal">
            <h2>Test Cases</h2>
            <div class="row mb-2">
                <div class="col-md-2-4">
                    <select id="filterType" class="form-select" onchange="applyTestCasesFilters()">
                        <option value="">Filter by Type</option>
                    </select>
                </div>
                <div class="col-md-2-4">
                    <select id="filterIssueType" class="form-select" onchange="applyTestCasesFilters()">
                        <option value="">Filter by Issue Type</option>
                    </select>
                </div>
                <div class="col-md-2-4">
                    <select id="filterJiraStatus" class="form-select" onchange="applyTestCasesFilters()">
                        <option value="">Filter by Jira Status</option>
                    </select>
                </div>
                <div class="col-md-2-4">
                    <select id="filterStatus" class="form-select" onchange="applyTestCasesFilters()">
                        <option value="">Filter by Status</option>
                    </select>
                </div>
                <div class="col-md-2-4">
                    <select id="filterAssignedTo" class="form-select" onchange="applyTestCasesFilters()">
                        <option value="">Filter by Assigned To</option>
                    </select>
                </div>
            </div>
            <div class="total-count" id="testCasesCount">Total Test Cases: 0</div>
            <table id="testCasesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Version</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Type</th>
                        <th>Issue Type</th>
                        <th>Jira Status</th>
                    </tr>
                </thead>
                <tbody id="testCasesTableBody"></tbody>
            </table>
            <div class="pagination" id="testCasesPagination"></div>
            <button class="btn btn-secondary" onclick="closeTestCasesModal()">Close</button>
        </div>
		
		
		<div id="trendViewModal" class="modal large-modal">
    <h2>Engagement Creation Trend</h2>
    <div class="row mb-2">
        <div class="col-md-3">
            <input type="date" id="trendDate1" class="form-control" onchange="applyTrendFilters()">
        </div>
        <div class="col-md-3">
            <input type="date" id="trendDate2" class="form-control" onchange="applyTrendFilters()">
        </div>
    </div>
    <canvas id="trendChart" width="800" height="400"></canvas>
    <button class="btn btn-secondary mt-2" onclick="closeTrendViewModal()">Close</button>
</div>
		
		
<!-- Reassignment Modal -->
<div id="reassignmentModal" class="modal large-modal">
    <h2>Reassignment</h2>
    <div class="row mb-2">
        <div class="col-md-2">
            <select id="reassignTypeFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Type</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="reassignVersionFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Version</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="reassignIssueTypeFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Issue Type</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="reassignJiraStatusFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Jira Status</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="reassignStatusFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Status</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="reassignAssignedToFilter" class="form-select" onchange="applyReassignmentFilters()">
                <option value="">Filter by Assigned To</option>
            </select>
        </div>
    </div>
    <table id="reassignmentTable">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                <th>ID</th>
                <th>Title</th>
                <th>Type</th>
                <th>Version</th>
                <th>Issue Type</th>
                <th>Jira Status</th>
                <th>Status</th>
                <th>Assigned To</th>
            </tr>
        </thead>
        <tbody id="reassignmentTableBody"></tbody>
    </table>
    <div class="pagination" id="reassignmentPagination"></div>
    <div id="reassignButtonContainer" style="display: none;" class="mt-2">
        <button class="btn btn-primary" onclick="showReassignConfirmModal()">Reassign</button>
    </div>
    <button class="btn btn-secondary mt-2" onclick="closeReassignmentModal()">Close</button>
</div>

<!-- Reassign Confirmation Modal -->
<div id="reassignConfirmModal" class="modal">
    <h2>Reassign Selected Tests</h2>
    <div class="mb-2">
        <select id="reassignToUser" class="form-select">
            <option value="">Select User to Reassign To</option>
        </select>
    </div>
    <div class="mb-2">
        <label>Or Divide Among Multiple Users:</label>
        <input type="number" id="divideAmongUsers" class="form-control" min="1" placeholder="Number of users to divide among" onchange="showUserCheckboxes()">
    </div>
    <div id="userCheckboxContainer" class="mb-2" style="display: none; max-height: 200px; overflow-y: auto;">
        <h3>Select Users</h3>
        <input type="text" id="userSearch" class="form-control mb-2" placeholder="Search users..." oninput="filterUsers()">
        <div id="userCheckboxes"></div>
        <div class="pagination mt-2" id="userPagination"></div>
    </div>
    <div class="d-flex justify-content-between">
        <button class="btn btn-primary" onclick="confirmReassignment()">Confirm</button>
        <button class="btn btn-secondary" onclick="closeReassignConfirmModal()">Cancel</button>
    </div>
</div>	
		
		
		
		
		
		
		
		
		
		
		
		
		
        <div id="analystViewModal" class="modal large-modal">
            <h2>View by Analyst</h2>
            <div class="row mb-2">
                <div class="col-md-3">
                    <select id="analystAssignedToFilter" class="form-select" onchange="applyAnalystFilters()">
                        <option value="">Filter by Assigned To</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="analystTypeFilter" class="form-select" onchange="applyAnalystFilters()">
                        <option value="">Filter by Type</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="analystVersionFilter" class="form-select" onchange="applyAnalystFilters()">
                        <option value="">Filter by Version</option>
                    </select>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-secondary btn-clear" onclick="clearAnalystFilters()" data-tooltip="Clear Filters">â†º</button>
                </div>
            </div>
            <table id="analystTable">
                <thead>
                    <tr>
                        <th>Assigned To</th>
                        <th>Type</th>
                        <th>Version</th>
                        <th>Pending</th>
                        <th>On Hold</th>
                        <th>Completed</th>
                        <th>Rejected</th>
                        <th>Doable</th>
                        <th>Non Doable</th>
                    </tr>
                </thead>
                <tbody id="analystTableBody"></tbody>
            </table>
            <button class="btn btn-secondary mt-2" onclick="closeAnalystViewModal()">Close</button>
        </div>
		
		
<div id="completedSummaryModal" class="modal large-modal">
    <h2>Completed Summary</h2>
    <div class="row mb-2">
        <div class="col-md-3">
            <input type="date" id="completedDate1" class="form-control" onchange="applyCompletedFilters()">
        </div>
        <div class="col-md-3">
            <input type="date" id="completedDate2" class="form-control" onchange="applyCompletedFilters()">
        </div>
    </div>
    <table id="completedSummaryTable">
        <thead>
            <tr>
                <th>Assigned To</th>
                <th>Version</th>
                <th>Completed Count</th>
            </tr>
        </thead>
        <tbody id="completedSummaryTableBody"></tbody>
    </table>
    <button class="btn btn-secondary mt-2" onclick="closeCompletedSummaryModal()">Close</button>
</div>

<div id="createSCTModal" class="modal">
    <h2>Create SCT</h2>
    <div class="mb-2">
        <textarea id="engagementNames" class="form-control" rows="5" placeholder="Enter comma-separated engagement names"></textarea>
    </div>
    <div class="d-flex justify-content-between mb-2">
        <button class="btn btn-primary" onclick="createEngagements()">Create</button>
        <button class="btn btn-secondary" onclick="closeCreateSCTModal()">Cancel</button>
    </div>
    <div id="createSummary" style="display: none;">
        <h3>Summary</h3>
        <table>
            <thead>
                <tr>
                    <th colspan="2">Engagements Created</th>
                </tr>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody id="createdTableBody"></tbody>
        </table>
        <table>
            <thead>
                <tr>
                    <th>Skipped (Already Exists)</th>
                </tr>
            </thead>
            <tbody id="skippedTableBody"></tbody>
        </table>
        <table>
            <thead>
                <tr>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody id="errorTableBody"></tbody>
        </table>
    </div>
</div>



<!-- Modify the totalTestCountsModal to include Type filter -->
<div id="totalTestCountsModal" class="modal">
    <h2>Total Test Counts (Open SCT)</h2>
    <div class="row mb-2">
        <div class="col-md-3">
            <select id="totalTypeFilter" class="form-select" onchange="updateTotalTestCounts()">
                <option value="">Filter by Type</option>
            </select>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Completed</th>
                <th>Pending</th>
                <th>On Hold</th>
                <th>Rejected</th>
                <th>Doable Jira</th>
                <th>Non-Doable Jira</th>
            </tr>
        </thead>
        <tbody id="totalTestCountsBody">
            <tr>
                <td id="totalCompleted">0</td>
                <td id="totalPending">0</td>
                <td id="totalOnHold">0</td>
                <td id="totalRejected">0</td>
                <td id="totalDoable">0</td>
                <td id="totalNonDoable">0</td>
            </tr>
        </tbody>
    </table>
    <button class="btn btn-secondary mt-2" onclick="closeTotalTestCountsModal()">Close</button>
</div>




<!-- The HTML remains unchanged as it only defines the structure -->
<div id="overallSummaryModal" class="modal large-modal">
    <div style="text-align: left; padding: 20px; font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
        <h2 style="color: var(--bs-dark); border-bottom: 2px solid var(--bs-blue); padding-bottom: 10px;">Overall Summary</h2>
        <div id="summaryContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>
        <button class="btn btn-secondary mt-3" onclick="closeOverallSummaryModal()">Close</button>
    </div>
</div>


<!-- Report Modal -->
<div id="reportModal" class="modal large-modal">
    <div style="text-align: left; padding: 20px; font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
        <h2 style="color: var(--bs-dark); border-bottom: 2px solid var(--bs-blue); padding-bottom: 10px;">Engagement Report</h2>
        <div class="mb-2">
            <select id="reportEngagementSelect" class="form-select" onchange="generateReport()">
                <option value="">Select an Engagement</option>
            </select>
        </div>
        <div id="reportContent" style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-y: auto; max-height: 60vh;"></div>
        <button class="btn btn-secondary mt-3" onclick="closeReportModal()">Close</button>
    </div>
</div>



		
    </div>

    <script>
        const BASE_URL = "https://demo.defectdojo.org/api/v2";
        let csrfToken = '';
        let usersList = [];
        let debounceTimeout;
        const ROWS_PER_PAGE = 10;
        const TEST_CASES_PER_PAGE = 5;
        let currentPageOpen = 1;
        let currentPageClosed = 1;
        let currentTestCasesPage = 1;
        let allEngagements = [];
        let openEngagements = [];
        let closedEngagements = [];
        let testCases = [];
        let filteredTestCases = [];
        let environmentCache = {};
        let currentEngagementId = null;
        let analystData = []; // Store original analyst data for filtering
		let completedSummaryData = []; // Store original completed summary data for filtering
		let trendChart = null;
		let reassignmentTests = [];
		let filteredReassignmentTests = [];
		let reassignmentPage = 1;
		const REASSIGNMENT_ROWS_PER_PAGE = 10;
		const USERS_PER_PAGE = 5;
		let userPage = 1;











function showReportModal() {
    const modal = document.getElementById("reportModal");
    const overlay = document.getElementById("modalOverlay");
    const select = document.getElementById("reportEngagementSelect");

    // Populate dropdown with Open SCT engagements
    select.innerHTML = '<option value="">Select an Engagement</option>' + 
        openEngagements.map(eng => `<option value="${eng.id}">${eng.name}</option>`).join('');

    // Clear previous report content
    document.getElementById("reportContent").innerHTML = '';

    modal.style.display = "block";
    overlay.style.display = "block";
}

function closeReportModal() {
    const modal = document.getElementById("reportModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}

async function generateReport() {
    const engagementId = document.getElementById("reportEngagementSelect").value;
    if (!engagementId) {
        document.getElementById("reportContent").innerHTML = '<p style="color: #721c24;">Please select an engagement to generate the report.</p>';
        return;
    }

    const engagement = openEngagements.find(eng => eng.id == engagementId);
    if (!engagement) {
        document.getElementById("reportContent").innerHTML = '<p style="color: #721c24;">Engagement not found!</p>';
        return;
    }

    // Ensure test cases are fetched
    if (!engagement.testCases || engagement.testCases.length === 0) {
        const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}`);
        const data = await response.json();
        engagement.testCases = data.results || [];
    }

    const testCases = engagement.testCases;
    const today = new Date().toISOString().split('T')[0];
    const functionalJiras = testCases.filter(tc => tc.commit_hash !== "Security").length;
    const securityJiras = testCases.filter(tc => tc.commit_hash === "Security").length;

    // Section 1: Summary
    let summaryContent = `
        <h3 style="color: var(--bs-blue); margin-top: 20px;">Summary</h3>
        <p><strong>Name:</strong> ${engagement.name}</p>
        <p><strong>Category:</strong> Activity</p>
        <p><strong>Total Changelogs:</strong></p>
        <ul>
            <li>Number of Functional Jira: ${functionalJiras}</li>
            <li>Number of Security Jira: ${securityJiras}</li>
        </ul>
        <p><strong>Contrast Verification:</strong> ${engagement.contrast_deployed ? 'Yes' : 'No'}</p>
        <p><strong>Conclusion:</strong></p>
        <ul>
            <li>Security Jira found: ${securityJiras}</li>
            <li>Manual Code Review: Done</li>
            <li>Logical Testing: Done</li>
            <li>Did we close/Change status to Done for all Security Jiras? No</li>
            <li>Functional Jira Count: ${functionalJiras}</li>
            <li>Did we download the patch and reviewed all files? No</li>
            <li>What are the files/folders we haven't covered or reviewed and why? <em>Not specified</em></li>
            <li>Did we find any vulnerability while review? No</li>
            <li>Following is the Security Analysis: <em>See Security Analysis section below</em></li>
        </ul>
    `;

    // Section 2: Build
    const reviewers = [...new Set(testCases.map(tc => {
        const lead = usersList.find(user => user.id == tc.lead);
        return lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
    }))].join(', ');
    let buildContent = `
        <h3 style="color: var(--bs-blue); margin-top: 20px;">Build</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background: var(--bs-gray-200);">
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Build</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Date</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Total No. of Jiras</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Changelog Reviewers</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Total Time Taken</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Issue Key</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Test Approach</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Manual Secure Code Review</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Manual Security Testing</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Remark/Comment</th>
                </tr>
            </thead>
            <tbody>
    `;
    testCases.forEach(tc => {
        const isSecurity = tc.commit_hash === "Security";
        const secureCodeReview = tc.description && tc.description.toLowerCase().includes("secure code review: done") ? "Done" : "Not Done";
        const manualTesting = tc.description && tc.description.toLowerCase().includes("manual testing: na") ? "NA" : "Done";
        buildContent += `
            <tr style="background: #fafafa;">
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${engagement.name}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${today}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${testCases.length}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${reviewers}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">N/A</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${tc.id}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${isSecurity ? 'Security Jira' : 'Functional Jira'}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${secureCodeReview}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${manualTesting}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${tc.description || 'N/A'}</td>
            </tr>
        `;
    });
    buildContent += `
            </tbody>
        </table>
    `;

    // Section 3: Security Analysis
    let securityAnalysisContent = `
        <h3 style="color: var(--bs-blue); margin-top: 20px;">Security Analysis</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background: var(--bs-gray-200);">
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Sr. No.</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Category</th>
                    <th style="padding: 8px; border: 1px solid #e0e0e0;">Status</th>
                </tr>
            </thead>
            <tbody>
    `;
    const securityCategories = [
        "SQL Injection", "XSS- Cross-Site Scripting", "Path Traversal", "Command Injection", "XXE",
        "Readline Vulnerability", "Header Injection", "Insecure deserialization", "Session test on the product",
        "Out of band communication", "Sensitive information in queryString", "Vulnerable Cryptographic algorithms",
        "Sensitive Information in Logs", "Trust Boundary Violation", "Sensitive data closure in response",
        "Hardcoded Credentials", "CSV Injection", "Unrestricted File Upload", "Unnecessary files present in the distribution",
        "Server-Side Request forgery", "Vulnerable Components (Jar/Js)", "Root detection /Jailbreak detection bypass",
        "Improper error handling & Testing for Stack Traces", "Testing for reverse tabnabbing", "Weak access control",
        "Weak random number", "Sessionless js", "Removal of jcryption files", "Loginjection", "Avoid inline javascript",
        "Misconfigured security headers", "Critical/High Security jira open", "Is an additional class for cryptography created?",
        "Is there any table name included in the client-side code, such as in JSP, or Javascript?", "Zip-Slip Issue Verification"
    ];
    securityCategories.forEach((category, index) => {
        securityAnalysisContent += `
            <tr style="background: #fafafa;">
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${index + 1}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">${category}</td>
                <td style="padding: 8px; border: 1px solid #e0e0e0;">Not Found</td>
            </tr>
        `;
    });
    securityAnalysisContent += `
            </tbody>
        </table>
    `;

    // Combine all sections
    const reportContent = `${summaryContent}${buildContent}${securityAnalysisContent}`;
    document.getElementById("reportContent").innerHTML = reportContent;
}














// Add this new function to fetch the logged-in user's name
async function summary_greeting() {
    try {
        const response = await fetch("https://demo.defectdojo.org/api/v2/user_profile/", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            credentials: "include"
        });

        if (response.ok) {
            const userData = await response.json();
            const firstName = userData.first_name || "";
            const lastName = userData.last_name || "";
            return `<strong>${firstName} ${lastName}</strong>`;
        } else {
            console.error("Failed to fetch user profile:", response.status);
            return " <strong></strong>";
        }
    } catch (error) {
        console.error("Error fetching user profile for greeting:", error);
        return "<strong></strong>";
    }
}

// Modified showOverallSummary function
async function showOverallSummary() {
    try {
        // Fetch the greeting with the logged-in user's name
        const greeting = await summary_greeting();

        // Calculate today's date and yesterday's date (considering weekends)
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - (today.getDay() === 1 ? 3 : 1)); // If Monday, go back to Friday
        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        // Open Engagements Summary
        let openEngagementsSummary = '';
        openEngagements.forEach((engagement, index) => {
            const testCases = engagement.testCases || [];
            const totalKey = testCases.length;
            const pending = testCases.filter(tc => tc.branch_tag === "Pending").length;
            const onHold = testCases.filter(tc => tc.branch_tag === "On Hold").length;
            const doable = testCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
            const nonDoable = totalKey - doable;

            openEngagementsSummary += `
                ${index + 1}. <strong>${engagement.name}</strong> has a total of <strong>${totalKey}</strong> tests, 
                out of which <strong>${pending}</strong> are in Pending, <strong>${onHold}</strong> are in On Hold, 
                <strong>${doable}</strong> are Doable, and <strong>${nonDoable}</strong> are Non-Doable.<br>`;
        });

        // Today's Received Engagements with crm tag
        const todayEngagements = allEngagements.filter(e => e.created.split('T')[0] === todayStr && e.tags.includes('crm'));
        let todayReceivedSummary = '';
        todayEngagements.forEach((engagement, index) => {
            const crmJiraTests = (engagement.testCases || []).filter(tc => tc.tags && tc.tags.includes('crm_jira')).length;
            todayReceivedSummary += `
                ${index + 1}. <strong>${engagement.name}</strong>: <strong>${crmJiraTests}</strong> Jira tests received.<br>`;
        });

        // Work Completed Yesterday (or Friday if today is Monday) - Group by user
        const completedYesterdayByUser = {};
        allEngagements
            .flatMap(e => e.testCases || [])
            .filter(tc => tc.branch_tag === "Completed" && tc.updated && tc.updated.split('T')[0] === yesterdayStr)
            .forEach(tc => {
                const lead = usersList.find(user => user.id == tc.lead);
                const leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                completedYesterdayByUser[leadName] = (completedYesterdayByUser[leadName] || 0) + 1;
            });

        let workCompletedSummary = '';
        Object.entries(completedYesterdayByUser).forEach(([userName, count], index) => {
            workCompletedSummary += `
                ${index + 1}. On <strong>${yesterdayStr}</strong>, <strong>${userName}</strong> completed <strong>${count}</strong> tests.<br>`;
        });
        if (!workCompletedSummary) {
            workCompletedSummary = `No tests were completed on <strong>${yesterdayStr}</strong>.`;
        }

        // Construct the summary
        const summaryContent = `
            <p style="font-size: 1.1rem; color: #2c3e50;">${greeting},</p>
            <p style="font-size: 1rem; color: #495057;"></p>
            
            <h3 style="color: var(--bs-blue); margin-top: 20px;">Open Engagements and Their Test Counts</h3>
            <p>In MCR, we have a total of <strong>${openEngagements.length}</strong> engagements open. Below are the details:</p>
            <div style="margin-left: 20px; color: #495057;">${openEngagementsSummary || 'No open engagements currently.'}</div>
            
            <h3 style="color: var(--bs-blue); margin-top: 20px;">Todayâ€™s Received Engagements</h3>
            <p>Today, we received a total of <strong>${todayEngagements.length}</strong> engagements with the CRM tag. Below are the Jira counts received:</p>
            <div style="margin-left: 20px; color: #495057;">${todayReceivedSummary || 'No engagements received today.'}</div>
            
            <h3 style="color: var(--bs-blue); margin-top: 20px;">Work Completed</h3>
            <div style="margin-left: 20px; color: #495057;">${workCompletedSummary}</div>
        `;

        // Display the summary
        document.getElementById("summaryContent").innerHTML = summaryContent;

        const modal = document.getElementById("overallSummaryModal");
        const overlay = document.getElementById("modalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
    } catch (error) {
        console.error("Error generating overall summary:", error);
        showAlert("Error loading overall summary!", "danger");
    }
}

// The closeOverallSummaryModal function remains unchanged
function closeOverallSummaryModal() {
    const modal = document.getElementById("overallSummaryModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}






async function showTotalTestCounts() {
    try {
        // Populate Type filter
        const typeFilter = document.getElementById("totalTypeFilter");
        let allTestCases = [];
        
        // Fetch all test cases if not already available
        for (const engagement of openEngagements) {
            if (!engagement.testCases || engagement.testCases.length === 0) {
                const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}`);
                const data = await response.json();
                engagement.testCases = data.results || [];
            }
            allTestCases = allTestCases.concat(engagement.testCases);
        }

        // Get unique environment names (Types)
        await Promise.all(allTestCases.map(async tc => {
            tc.environmentName = await fetchEnvironmentName(tc.environment);
        }));
        
        const uniqueTypes = [...new Set(allTestCases.map(tc => tc.environmentName || 'N/A'))].sort();
        typeFilter.innerHTML = '<option value="">Filter by Type</option>' + 
            uniqueTypes.map(val => `<option value="${val}">${val}</option>`).join('');

        // Update counts
        updateTotalTestCounts();

        // Show modal
        const modal = document.getElementById("totalTestCountsModal");
        const overlay = document.getElementById("modalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
    } catch (error) {
        console.error("Error showing total test counts:", error);
        showAlert("Error loading total test counts!", "danger");
    }
}

function updateTotalTestCounts() {
    const jiraAssignedFilter = document.getElementById("jiraAssignedFilterOpen").value;
    const typeFilter = document.getElementById("totalTypeFilter").value;
    
    let totalCompleted = 0;
    let totalPending = 0;
    let totalOnHold = 0;
    let totalRejected = 0;
    let totalDoable = 0;
    let totalNonDoable = 0;

    openEngagements.forEach(engagement => {
        let filteredTestCases = engagement.testCases || [];
        
        if (jiraAssignedFilter) {
            filteredTestCases = filteredTestCases.filter(tc => tc.lead == jiraAssignedFilter);
        }
        
        if (typeFilter) {
            filteredTestCases = filteredTestCases.filter(tc => tc.environmentName === typeFilter);
        }

        const completed = filteredTestCases.filter(tc => tc.branch_tag === "Completed").length;
        const pending = filteredTestCases.filter(tc => tc.branch_tag === "Pending").length;
        const onHold = filteredTestCases.filter(tc => tc.branch_tag === "On Hold").length;
        const rejected = filteredTestCases.filter(tc => tc.branch_tag === "Rejected").length;
        const doable = filteredTestCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
        const nonDoable = filteredTestCases.length - doable;

        totalCompleted += completed;
        totalPending += pending;
        totalOnHold += onHold;
        totalRejected += rejected;
        totalDoable += doable;
        totalNonDoable += nonDoable;
    });

    document.getElementById("totalCompleted").textContent = totalCompleted;
    document.getElementById("totalPending").textContent = totalPending;
    document.getElementById("totalOnHold").textContent = totalOnHold;
    document.getElementById("totalRejected").textContent = totalRejected;
    document.getElementById("totalDoable").textContent = totalDoable;
    document.getElementById("totalNonDoable").textContent = totalNonDoable;
}

// Keep the close function unchanged
function closeTotalTestCountsModal() {
    const modal = document.getElementById("totalTestCountsModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}





async function showReassignmentModal() {
    try {
        let allTestCases = [];
        for (const engagement of openEngagements) {
            const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}`);
            const data = await response.json();
            allTestCases = allTestCases.concat(data.results || []);
        }

        reassignmentTests = await Promise.all(allTestCases.map(async tc => {
            const lead = usersList.find(user => user.id == tc.lead);
            tc.leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
            tc.environmentName = await fetchEnvironmentName(tc.environment);
            return tc;
        }));

        filteredReassignmentTests = [...reassignmentTests];
        reassignmentPage = 1;

        populateReassignmentFilters();
        renderReassignmentTable(reassignmentPage);

        const modal = document.getElementById("reassignmentModal");
        const overlay = document.getElementById("modalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
    } catch (error) {
        console.error("Error loading reassignment modal:", error);
        showAlert("Error loading reassignment data!", "danger");
    }
}

function populateReassignmentFilters() {
    const typeFilter = document.getElementById("reassignTypeFilter");
    const versionFilter = document.getElementById("reassignVersionFilter");
    const issueTypeFilter = document.getElementById("reassignIssueTypeFilter");
    const jiraStatusFilter = document.getElementById("reassignJiraStatusFilter");
    const statusFilter = document.getElementById("reassignStatusFilter");
    const assignedToFilter = document.getElementById("reassignAssignedToFilter");

    const uniqueTypes = [...new Set(reassignmentTests.map(tc => tc.environmentName || 'N/A'))].sort();
    const uniqueVersions = [...new Set(reassignmentTests.map(tc => tc.version || 'N/A'))].sort();
    const uniqueIssueTypes = [...new Set(reassignmentTests.map(tc => tc.commit_hash || 'N/A'))].sort();
    const uniqueJiraStatuses = [...new Set(reassignmentTests.map(tc => tc.build_id || 'N/A'))].sort();
    const uniqueStatuses = [...new Set(reassignmentTests.map(tc => tc.branch_tag || 'N/A'))].sort();
    const uniqueAssignedTos = [...new Set(reassignmentTests.map(tc => tc.leadName || 'Unassigned'))].sort();

    typeFilter.innerHTML = '<option value="">Filter by Type</option>' + uniqueTypes.map(val => `<option value="${val}">${val}</option>`).join('');
    versionFilter.innerHTML = '<option value="">Filter by Version</option>' + uniqueVersions.map(val => `<option value="${val}">${val}</option>`).join('');
    issueTypeFilter.innerHTML = '<option value="">Filter by Issue Type</option>' + uniqueIssueTypes.map(val => `<option value="${val}">${val}</option>`).join('');
    jiraStatusFilter.innerHTML = '<option value="">Filter by Jira Status</option>' + uniqueJiraStatuses.map(val => `<option value="${val}">${val}</option>`).join('');
    statusFilter.innerHTML = '<option value="">Filter by Status</option>' + uniqueStatuses.map(val => `<option value="${val}">${val}</option>`).join('');
    assignedToFilter.innerHTML = '<option value="">Filter by Assigned To</option>' + uniqueAssignedTos.map(val => `<option value="${val}">${val}</option>`).join('');
}

function applyReassignmentFilters() {
    const typeFilter = document.getElementById("reassignTypeFilter").value;
    const versionFilter = document.getElementById("reassignVersionFilter").value;
    const issueTypeFilter = document.getElementById("reassignIssueTypeFilter").value;
    const jiraStatusFilter = document.getElementById("reassignJiraStatusFilter").value;
    const statusFilter = document.getElementById("reassignStatusFilter").value;
    const assignedToFilter = document.getElementById("reassignAssignedToFilter").value;

    filteredReassignmentTests = reassignmentTests.filter(tc => {
        return (!typeFilter || tc.environmentName === typeFilter) &&
               (!versionFilter || tc.version === versionFilter) &&
               (!issueTypeFilter || tc.commit_hash === issueTypeFilter) &&
               (!jiraStatusFilter || tc.build_id === jiraStatusFilter) &&
               (!statusFilter || tc.branch_tag === statusFilter) &&
               (!assignedToFilter || tc.leadName === assignedToFilter);
    });

    reassignmentPage = 1;
    renderReassignmentTable(reassignmentPage);
}

function renderReassignmentTable(page) {
    const tableBody = document.getElementById("reassignmentTableBody");
    tableBody.innerHTML = "";
    const start = (page - 1) * REASSIGNMENT_ROWS_PER_PAGE;
    const end = start + REASSIGNMENT_ROWS_PER_PAGE;
    const paginatedTests = filteredReassignmentTests.slice(start, end);

    paginatedTests.forEach(tc => {
        const row = document.createElement("tr");
        row.dataset.id = tc.id;
        row.innerHTML = `
            <td><input type="checkbox" class="rowCheckbox" onchange="updateReassignButton()"></td>
            <td>${tc.id}</td>
            <td>${tc.title || ''}</td>
            <td>${tc.environmentName || 'N/A'}</td>
            <td>${tc.version || 'N/A'}</td>
            <td>${tc.commit_hash || 'N/A'}</td>
            <td>${tc.build_id || 'N/A'}</td>
            <td>${tc.branch_tag || 'N/A'}</td>
            <td>${tc.leadName}</td>
        `;
        tableBody.appendChild(row);
    });

    renderReassignmentPagination();
    updateReassignButton();
}

function renderReassignmentPagination() {
    const totalPages = Math.ceil(filteredReassignmentTests.length / REASSIGNMENT_ROWS_PER_PAGE);
    const pagination = document.getElementById("reassignmentPagination");
    pagination.innerHTML = "";

    const firstItem = document.createElement("div");
    firstItem.className = `page-item ${reassignmentPage === 1 ? 'active' : ''}`;
    firstItem.textContent = "First";
    firstItem.onclick = () => { reassignmentPage = 1; renderReassignmentTable(reassignmentPage); };
    pagination.appendChild(firstItem);

    const prevItem = document.createElement("div");
    prevItem.className = "page-item";
    prevItem.textContent = "Previous";
    prevItem.onclick = () => { if (reassignmentPage > 1) { reassignmentPage--; renderReassignmentTable(reassignmentPage); } };
    pagination.appendChild(prevItem);

    const nextItem = document.createElement("div");
    nextItem.className = "page-item";
    nextItem.textContent = "Next";
    nextItem.onclick = () => { if (reassignmentPage < totalPages) { reassignmentPage++; renderReassignmentTable(reassignmentPage); } };
    pagination.appendChild(nextItem);

    const lastItem = document.createElement("div");
    lastItem.className = `page-item ${reassignmentPage === totalPages ? 'active' : ''}`;
    lastItem.textContent = "Last";
    lastItem.onclick = () => { reassignmentPage = totalPages; renderReassignmentTable(reassignmentPage); };
    pagination.appendChild(lastItem);
}

function toggleSelectAll() {
    const selectAll = document.getElementById("selectAll");
    const checkboxes = document.querySelectorAll(".rowCheckbox");
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateReassignButton();
}

function updateReassignButton() {
    const checkedCount = document.querySelectorAll(".rowCheckbox:checked").length;
    const reassignButtonContainer = document.getElementById("reassignButtonContainer");
    reassignButtonContainer.style.display = checkedCount > 0 ? "block" : "none";
}

function showReassignConfirmModal() {
    const modal = document.getElementById("reassignConfirmModal");
    const reassignToUser = document.getElementById("reassignToUser");
    reassignToUser.innerHTML = '<option value="">Select User to Reassign To</option>' + 
        usersList.map(user => `<option value="${user.id}">${user.first_name} ${user.last_name}</option>`).join('');
    document.getElementById("divideAmongUsers").value = '';
    const userCheckboxContainer = document.getElementById("userCheckboxContainer");
    userCheckboxContainer.style.display = "none";
    document.getElementById("userSearch").value = ''; // Clear search input
    userPage = 1; // Reset pagination
    showUserCheckboxes(); // Initial call to populate users
    modal.style.display = "block";
}

function showUserCheckboxes() {
    const divideAmongUsers = parseInt(document.getElementById("divideAmongUsers").value) || 0;
    const userCheckboxContainer = document.getElementById("userCheckboxContainer");
    const userCheckboxes = document.getElementById("userCheckboxes");

    if (divideAmongUsers > 0) {
        renderUserCheckboxes();
        userCheckboxContainer.style.display = "block";
    } else {
        userCheckboxContainer.style.display = "none";
    }
}

function renderUserCheckboxes(searchTerm = '') {
    const userCheckboxes = document.getElementById("userCheckboxes");
    const existingChecks = new Set(
        Array.from(document.querySelectorAll("#userCheckboxes input:checked")).map(input => input.value)
    );

    // Split users into selected and unselected
    const selectedUsers = usersList.filter(user => existingChecks.has(user.id.toString()));
    const unselectedUsers = usersList.filter(user => !existingChecks.has(user.id.toString()));
    let filteredUsers = [...selectedUsers, ...unselectedUsers];

    // Apply search filter
    if (searchTerm) {
        const lowerSearch = searchTerm.toLowerCase();
        filteredUsers = filteredUsers.filter(user => 
            `${user.first_name} ${user.last_name}`.toLowerCase().includes(lowerSearch)
        );
    }

    // Pagination logic
    const start = (userPage - 1) * USERS_PER_PAGE;
    const end = start + USERS_PER_PAGE;
    const paginatedUsers = filteredUsers.slice(start, end);

    userCheckboxes.innerHTML = paginatedUsers.map(user => `
        <div>
            <input type="checkbox" id="user_${user.id}" value="${user.id}" ${existingChecks.has(user.id.toString()) ? 'checked' : ''}>
            <label for="user_${user.id}">${user.first_name} ${user.last_name}</label>
        </div>
    `).join('');

    renderUserPagination(filteredUsers.length);
}

function renderUserPagination(totalUsers) {
    const totalPages = Math.ceil(totalUsers / USERS_PER_PAGE);
    const pagination = document.getElementById("userPagination");
    pagination.innerHTML = "";

    if (totalPages <= 1) return; // No pagination needed for 5 or fewer users

    const firstItem = document.createElement("div");
    firstItem.className = `page-item ${userPage === 1 ? 'active' : ''}`;
    firstItem.textContent = "First";
    firstItem.onclick = () => { userPage = 1; renderUserCheckboxes(document.getElementById("userSearch").value); };
    pagination.appendChild(firstItem);

    const prevItem = document.createElement("div");
    prevItem.className = "page-item";
    prevItem.textContent = "Previous";
    prevItem.onclick = () => { if (userPage > 1) { userPage--; renderUserCheckboxes(document.getElementById("userSearch").value); } };
    pagination.appendChild(prevItem);

    const nextItem = document.createElement("div");
    nextItem.className = "page-item";
    nextItem.textContent = "Next";
    nextItem.onclick = () => { if (userPage < totalPages) { userPage++; renderUserCheckboxes(document.getElementById("userSearch").value); } };
    pagination.appendChild(nextItem);

    const lastItem = document.createElement("div");
    lastItem.className = `page-item ${userPage === totalPages ? 'active' : ''}`;
    lastItem.textContent = "Last";
    lastItem.onclick = () => { userPage = totalPages; renderUserCheckboxes(document.getElementById("userSearch").value); };
    pagination.appendChild(lastItem);
}

function filterUsers() {
    userPage = 1; // Reset to first page on filter
    const searchTerm = document.getElementById("userSearch").value;
    renderUserCheckboxes(searchTerm);
}

async function confirmReassignment() {
    const selectedUserId = document.getElementById("reassignToUser").value;
    const divideAmongUsers = parseInt(document.getElementById("divideAmongUsers").value) || 0;
    const selectedTests = Array.from(document.querySelectorAll(".rowCheckbox:checked")).map(cb => {
        return filteredReassignmentTests.find(tc => tc.id == cb.closest('tr').dataset.id);
    });

    if (!selectedUserId && divideAmongUsers <= 0) {
        showAlert("Please select a user or specify number of users to divide among!", "danger");
        return;
    }

    try {
        if (divideAmongUsers > 0) {
            const selectedUserIds = Array.from(document.querySelectorAll("#userCheckboxes input:checked")).map(cb => cb.value);
            if (selectedUserIds.length !== divideAmongUsers) {
                showAlert(`Please select exactly ${divideAmongUsers} users!`, "danger");
                return;
            }
            if (selectedUserIds.length > selectedTests.length) {
                showAlert("More users selected than tests available!", "danger");
                return;
            }

            const testsPerUser = Math.floor(selectedTests.length / divideAmongUsers);
            const extraTests = selectedTests.length % divideAmongUsers;

            let testIndex = 0;
            for (let i = 0; i < divideAmongUsers; i++) {
                const userTests = selectedTests.slice(testIndex, testIndex + testsPerUser + (i < extraTests ? 1 : 0));
                const userId = selectedUserIds[i];

                for (const test of userTests) {
                    await reassignTest(test.id, userId);
                }
                testIndex += testsPerUser + (i < extraTests ? 1 : 0);
            }
        } else {
            // Reassign to single user
            for (const test of selectedTests) {
                await reassignTest(test.id, selectedUserId);
            }
        }

        showAlert(`${selectedTests.length} test(s) reassigned successfully!`, "success");
        closeReassignConfirmModal();
        await showReassignmentModal(); // Refresh the reassignment modal
        fetchEngagements(); // Refresh main table
    } catch (error) {
        console.error("Error reassigning tests:", error);
        showAlert("Error reassigning tests!", "danger");
    }
}

async function reassignTest(testId, userId) {
    const payload = { lead: userId };
    const response = await fetch(`${BASE_URL}/tests/${testId}/`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
        body: JSON.stringify(payload),
        credentials: "include"
    });

    if (!response.ok) {
        throw new Error(`Failed to reassign test ${testId}`);
    }
}

function closeReassignmentModal() {
    const modal = document.getElementById("reassignmentModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}

function closeReassignConfirmModal() {
    const modal = document.getElementById("reassignConfirmModal");
    modal.style.display = "none";
}

















async function showTrendView(tab) {
    try {
        const isOpenTabActive = tab === 'open';
        const engagements = isOpenTabActive ? openEngagements : closedEngagements;

        // Set default date range (last 7 days)
        const today = new Date();
        const defaultDate2 = today.toISOString().split('T')[0];
        const defaultDate1 = new Date(today);
        defaultDate1.setDate(today.getDate() - 6); // 7 days including today
        document.getElementById("trendDate1").value = defaultDate1.toISOString().split('T')[0];
        document.getElementById("trendDate2").value = defaultDate2;

        renderTrendChart(engagements);

        const modal = document.getElementById("trendViewModal");
        const overlay = document.getElementById("modalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
    } catch (error) {
        console.error("Error showing trend view:", error);
        showAlert("Error loading trend view!", "danger");
    }
}

function applyTrendFilters() {
    const isOpenTabActive = document.getElementById("open-tab").classList.contains("active");
    const engagements = isOpenTabActive ? openEngagements : closedEngagements;
    renderTrendChart(engagements);
}

async function renderTrendChart(engagements) {
    const date1 = document.getElementById("trendDate1").value;
    const date2 = document.getElementById("trendDate2").value;

    let filteredEngagements = engagements;
    if (date1 || date2) {
        const date1Obj = date1 ? new Date(date1) : null;
        const date2Obj = date2 ? new Date(date2) : null;
        
        if (date1Obj) date1Obj.setHours(0, 0, 0, 0);
        if (date2Obj) date2Obj.setHours(23, 59, 59, 999);

        filteredEngagements = engagements.filter(engagement => {
            const createdDate = new Date(engagement.created.split("T")[0]);
            return (!date1 || createdDate >= date1Obj) && (!date2 || createdDate <= date2Obj);
        });
    }

    // Prepare data for trend with version and jira counts
    const dateData = {};
    for (const engagement of filteredEngagements) {
        const date = engagement.created.split("T")[0];
        if (!dateData[date]) {
            dateData[date] = { 
                versions: new Set(), 
                jiras: 0, 
                engagements: [] 
            };
        }
        dateData[date].versions.add(engagement.version || 'N/A');
        const jiraCount = (engagement.testCases || []).filter(tc => tc.tags && tc.tags.includes('crm_jira')).length;
        dateData[date].jiras += jiraCount;
        dateData[date].engagements.push({
            name: engagement.name,
            jiraCount: jiraCount
        });
    }

    const dates = Object.keys(dateData).sort();
    const counts = dates.map(date => dateData[date].engagements.length);
    const tooltips = dates.map(date => ({
        versionCount: dateData[date].versions.size,
        jiraCount: dateData[date].jiras,
        engagements: dateData[date].engagements
    }));

    // Destroy existing chart if it exists
    if (trendChart) {
        trendChart.destroy();
    }

    const ctx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Engagements Created',
                data: counts,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label; // Date
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const tooltipData = tooltips[index];
                            return `Versions: ${tooltipData.versionCount}, Jiras: ${tooltipData.jiraCount}`;
                        },
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const tooltipData = tooltips[index];
                            return tooltipData.engagements.map(eng => 
                                `${eng.name}: ${eng.jiraCount}`
                            ).join('\n');
                        }
                    }
                }
            }
        }
    });
}

function closeTrendViewModal() {
    const modal = document.getElementById("trendViewModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }
}

async function showCompletedSummary(tab) {
    try {
        const isOpenTabActive = tab === 'open';
        const engagements = isOpenTabActive ? openEngagements : closedEngagements;
        const jiraAssignedFilter = isOpenTabActive 
            ? document.getElementById("jiraAssignedFilterOpen").value 
            : document.getElementById("jiraAssignedFilterClosed").value;

        let allTestCases = [];
        for (const engagement of engagements) {
            const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}&branch_tag=Completed`);
            const data = await response.json();
            allTestCases = allTestCases.concat(data.results || []);
        }

        if (jiraAssignedFilter) {
            allTestCases = allTestCases.filter(tc => tc.lead == jiraAssignedFilter);
        }

        await Promise.all(allTestCases.map(async tc => {
            const lead = usersList.find(user => user.id == tc.lead);
            tc.leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
            tc.updatedDate = tc.updated ? tc.updated.split("T")[0] : '';
        }));

        const summaryStats = {};

        allTestCases.forEach(tc => {
            const key = `${tc.leadName}|${tc.version || 'N/A'}`;
            if (!summaryStats[key]) {
                summaryStats[key] = { count: 0 };
            }
            summaryStats[key].count++;
        });

        completedSummaryData = Object.keys(summaryStats).map(key => {
            const [assignedTo, version] = key.split('|');
            return { assignedTo, version, count: summaryStats[key].count };
        });

        document.getElementById("completedDate1").value = '';
        document.getElementById("completedDate2").value = '';
        renderCompletedSummaryTable();

        const modal = document.getElementById("completedSummaryModal");
        const overlay = document.getElementById("modalOverlay");
        modal.style.display = "block";
        overlay.style.display = "block";
    } catch (error) {
        console.error("Error showing completed summary:", error);
        showAlert("Error loading completed summary!", "danger");
    }
}

function applyCompletedFilters() {
    renderCompletedSummaryTable();
}

function renderCompletedSummaryTable() {
    const tableBody = document.getElementById("completedSummaryTableBody");
    tableBody.innerHTML = '';

    const date1 = document.getElementById("completedDate1").value;
    const date2 = document.getElementById("completedDate2").value;

    let filteredData = [...completedSummaryData];

    if (date1 || date2) {
        filteredData = filteredData.filter(item => {
            const testCasesForItem = testCases.filter(tc => {
                const lead = usersList.find(user => user.id == tc.lead);
                const leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                const updatedDate = tc.updated ? tc.updated.split("T")[0] : '';
                return leadName === item.assignedTo && 
                       tc.version === item.version && 
                       tc.branch_tag === "Completed";
            });

            return testCasesForItem.some(tc => {
                const updatedDate = tc.updated ? tc.updated.split("T")[0] : '';
                const dateObj = new Date(updatedDate);
                const date1Obj = date1 ? new Date(date1) : null;
                const date2Obj = date2 ? new Date(date2) : null;

                if (date1Obj) date1Obj.setHours(0, 0, 0, 0);
                if (date2Obj) date2Obj.setHours(23, 59, 59, 999);

                return (!date1 || dateObj >= date1Obj) && 
                       (!date2 || dateObj <= date2Obj);
            });
        });

        filteredData = filteredData.map(item => {
            const testCasesForItem = testCases.filter(tc => {
                const lead = usersList.find(user => user.id == tc.lead);
                const leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                const updatedDate = tc.updated ? tc.updated.split("T")[0] : '';
                const dateObj = new Date(updatedDate);
                const date1Obj = date1 ? new Date(date1) : null;
                const date2Obj = date2 ? new Date(date2) : null;

                if (date1Obj) date1Obj.setHours(0, 0, 0, 0);
                if (date2Obj) date2Obj.setHours(23, 59, 59, 999);

                return leadName === item.assignedTo && 
                       tc.version === item.version && 
                       tc.branch_tag === "Completed" &&
                       (!date1 || dateObj >= date1Obj) && 
                       (!date2 || dateObj <= date2Obj);
            });
            return { ...item, count: testCasesForItem.length };
        }).filter(item => item.count > 0);
    }

    filteredData.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${item.assignedTo}</td>
            <td>${item.version}</td>
            <td>${item.count}</td>
        `;
        tableBody.appendChild(row);
    });

    // Add Total Row
    const totalRow = document.createElement("tr");
    totalRow.className = "total-row";
    const totalCount = filteredData.reduce((sum, item) => sum + item.count, 0);
    totalRow.innerHTML = `
        <td>Total</td>
        <td>-</td>
        <td>${totalCount}</td>
    `;
    tableBody.appendChild(totalRow);
}

function closeCompletedSummaryModal() {
    const modal = document.getElementById("completedSummaryModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}
		
		
		
		
		
		
		

        async function fetchCSRF() {
            try {
                const response = await fetch("https://demo.defectdojo.org/api/key-v2", { credentials: "include" });
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, "text/html");
                const csrfInput = doc.querySelector("input[name='csrfmiddlewaretoken']");
                if (csrfInput) {
                    csrfToken = csrfInput.value;
                    document.getElementById("csrfToken").innerText = csrfToken;
                } else {
                    console.error("CSRF token not found.");
                }
            } catch (error) {
                console.error("Error fetching CSRF Token:", error);
            }
        }

        function showAlert(message, type, name = null) {
            const alertBox = document.getElementById("alertBox");
            alertBox.className = `alert alert-${type}`;
            alertBox.innerHTML = type === "success" && name ? `${name} ${message}` : message;
            alertBox.style.display = "block";
            setTimeout(() => { alertBox.style.display = "none"; }, 3000);
        }

        function showModal(name, isReopen = false) {
            const modal = document.getElementById("closeModal");
            const overlay = document.getElementById("modalOverlay");
            const modalContent = document.getElementById("modalContent");
            modalContent.innerHTML = `${name} ${isReopen ? 'reopened' : 'closed'} successfully`;
            modal.style.display = "block";
            overlay.style.display = "block";
            setTimeout(() => {
                modal.style.display = "none";
                overlay.style.display = "none";
            }, 2000);
        }

        async function fetchLoggedInUser() {
            try {
                const response = await fetch(`${BASE_URL}/user_profile/`, { credentials: "include" });
                const data = await response.json();
                return data.id;
            } catch (error) {
                console.error("Error fetching logged-in user:", error);
                return null;
            }
        }

        async function fetchUsers() {
            try {
                const loggedInUserId = await fetchLoggedInUser();
                const response = await fetch(`${BASE_URL}/users/`);
                const data = await response.json();
                usersList = data.results || [];

                const leadFilterOpen = document.getElementById("leadFilterOpen");
                const leadFilterClosed = document.getElementById("leadFilterClosed");
                const jiraAssignedFilterOpen = document.getElementById("jiraAssignedFilterOpen");
                const jiraAssignedFilterClosed = document.getElementById("jiraAssignedFilterClosed");

                if (leadFilterOpen && leadFilterClosed) {
                    [leadFilterOpen, leadFilterClosed].forEach(leadFilter => {
                        leadFilter.innerHTML = `<option value="">Filter by SCT assigned</option>`;
                        usersList.forEach(user => {
                            const option = document.createElement("option");
                            option.value = user.id;
                            option.textContent = `${user.first_name} ${user.last_name}`;
                            leadFilter.appendChild(option);
                        });
                        if (loggedInUserId) leadFilter.value = loggedInUserId;
                    });
                }

                if (jiraAssignedFilterOpen && jiraAssignedFilterClosed) {
                    [jiraAssignedFilterOpen, jiraAssignedFilterClosed].forEach(filter => {
                        filter.innerHTML = `<option value="">Filter by Jira(s) assigned</option>`;
                        usersList.forEach(user => {
                            const option = document.createElement("option");
                            option.value = user.id;
                            option.textContent = `${user.first_name} ${user.last_name}`;
                            filter.appendChild(option);
                        });
                    });
                }

                fetchEngagements();
            } catch (error) {
                console.error("Error fetching users:", error);
            }
        }

        async function fetchEnvironmentName(envId) {
            if (!envId) return 'N/A';
            if (environmentCache[envId]) return environmentCache[envId];

            try {
                const response = await fetch(`${BASE_URL}/development_environments/${envId}/`);
                const data = await response.json();
                environmentCache[envId] = data.name || 'Unknown';
                return environmentCache[envId];
            } catch (error) {
                console.error(`Error fetching environment ${envId}:`, error);
                environmentCache[envId] = 'Error';
                return 'Error';
            }
        }

        function clearFilters(tab) {
            if (tab === 'open') {
                document.getElementById("jiraAssignedFilterOpen").value = "";
                document.getElementById("nameSearchOpen").value = "";
                document.getElementById("leadFilterOpen").value = "";
                document.getElementById("date1Open").value = "";
                document.getElementById("date2Open").value = "";
            } else {
                document.getElementById("jiraAssignedFilterClosed").value = "";
                document.getElementById("nameSearchClosed").value = "";
                document.getElementById("leadFilterClosed").value = "";
                document.getElementById("date1Closed").value = "";
                document.getElementById("date2Closed").value = "";
            }
            fetchEngagements();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            if (tab === 'open') {
                renderTableOpen(currentPageOpen);
            } else {
                renderTableClosed(currentPageClosed);
            }
            updateTotalCount();
        }

        function updateTotalCount() {
            const activeTab = document.querySelector('.tab.active').textContent.trim();
            const count = activeTab === 'Open SCT' ? openEngagements.length : closedEngagements.length;
            document.getElementById("totalCount").textContent = `Total Engagements: ${count}`;
        }

        function renderTableOpen(page) {
            const tableBody = document.getElementById("engagementsTable");
            tableBody.innerHTML = "";
            const start = (page - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const paginatedEngagements = openEngagements.slice(start, end);
            const jiraAssignedFilter = document.getElementById("jiraAssignedFilterOpen").value;

            requestAnimationFrame(() => {
                paginatedEngagements.forEach((engagement, index) => {
                    const createdDate = engagement.created.split("T")[0];
                    const testCases = engagement.testCases || [];

                    let totalJiras, completed, pending, onHold, rejected, doableJiras, nonDoableJiras;
                    if (jiraAssignedFilter) {
                        const filteredTestCases = testCases.filter(tc => tc.lead == jiraAssignedFilter);
                        totalJiras = filteredTestCases.length;
                        completed = filteredTestCases.filter(tc => tc.branch_tag === "Completed").length;
                        pending = filteredTestCases.filter(tc => tc.branch_tag === "Pending").length;
                        onHold = filteredTestCases.filter(tc => tc.branch_tag === "On Hold").length;
                        rejected = filteredTestCases.filter(tc => tc.branch_tag === "Rejected").length;
                        doableJiras = filteredTestCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
                        nonDoableJiras = totalJiras - doableJiras;
                    } else {
                        totalJiras = testCases.length;
                        completed = testCases.filter(tc => tc.branch_tag === "Completed").length;
                        pending = testCases.filter(tc => tc.branch_tag === "Pending").length;
                        onHold = testCases.filter(tc => tc.branch_tag === "On Hold").length;
                        rejected = testCases.filter(tc => tc.branch_tag === "Rejected").length;
                        doableJiras = testCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
                        nonDoableJiras = totalJiras - doableJiras;
                    }

                    const row = document.createElement("tr");
                    row.dataset.id = engagement.id;
                    row.innerHTML = `
                        <td>${createdDate}</td>
                        <td class="${!jiraAssignedFilter && totalJiras === (completed + rejected) ? 'highlight-name' : ''}">${engagement.name}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'all')">${totalJiras}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Completed')">${completed}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Pending')">${pending}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'On Hold')">${onHold}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Rejected')">${rejected}</td>
                        <td>${doableJiras}</td>
                        <td>${nonDoableJiras}</td>
                        <td>${createDropdown(engagement.status)}</td>
                        <td>${createDropdown(engagement.commit_hash)}</td>
                        <td>${createDropdown(engagement.build_id)}</td>
                        <td>${createLeadDropdown(engagement.lead)}</td>
                        <td><input type="text" class="version-input" value="${engagement.version || ''}" data-id="${engagement.id}"></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="updateEngagement(${engagement.id}, '${engagement.name}', '${engagement.target_start}', '${engagement.target_end}', '${engagement.product}', '${engagement.lead}')">Save</button>
                            <button class="btn btn-danger btn-sm close-btn" data-id="${engagement.id}" disabled onclick="closeEngagement(${engagement.id}, '${engagement.name}', '${engagement.target_start}', '${engagement.target_end}', '${engagement.product}', '${engagement.lead}')">Close</button>
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Real-time saving for dropdowns and version input
                    const analystStatus = row.querySelector("td:nth-child(10) select");
                    const mentorStatus = row.querySelector("td:nth-child(11) select");
                    const leadStatus = row.querySelector("td:nth-child(12) select");
                    const versionInput = row.querySelector(".version-input");
                    const closeBtn = row.querySelector(".close-btn");

                    function updateCloseButton() {
                        const allCompleted = analystStatus.value === "Completed" && 
                                            mentorStatus.value === "Completed" && 
                                            leadStatus.value === "Completed";
                        closeBtn.disabled = !allCompleted;
                    }

                    // Save on change and alert on blur
                    [analystStatus, mentorStatus, leadStatus, versionInput].forEach(element => {
                        element.addEventListener("change", () => {
                            updateEngagement(engagement.id, engagement.name, engagement.target_start, engagement.target_end, engagement.product, engagement.lead);
                            updateCloseButton();
                        });
                        element.addEventListener("blur", () => {
                            showAlert("saved", "success", engagement.name);
                        });
                    });

                    updateCloseButton(); // Initial check
                });
            });

            renderPagination('open');
        }

        function renderTableClosed(page) {
            const tableBody = document.getElementById("closedEngagementsTable");
            tableBody.innerHTML = "";
            const start = (page - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const paginatedEngagements = closedEngagements.slice(start, end);
            const jiraAssignedFilter = document.getElementById("jiraAssignedFilterClosed").value;

            requestAnimationFrame(() => {
                paginatedEngagements.forEach(engagement => {
                    const createdDate = engagement.created.split("T")[0];
                    const testCases = engagement.testCases || [];

                    let totalJiras, completed, pending, onHold, rejected, doableJiras, nonDoableJiras;
                    if (jiraAssignedFilter) {
                        const filteredTestCases = testCases.filter(tc => tc.lead == jiraAssignedFilter);
                        totalJiras = filteredTestCases.length;
                        completed = filteredTestCases.filter(tc => tc.branch_tag === "Completed").length;
                        pending = filteredTestCases.filter(tc => tc.branch_tag === "Pending").length;
                        onHold = filteredTestCases.filter(tc => tc.branch_tag === "On Hold").length;
                        rejected = filteredTestCases.filter(tc => tc.branch_tag === "Rejected").length;
                        doableJiras = filteredTestCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
                        nonDoableJiras = totalJiras - doableJiras;
                    } else {
                        totalJiras = testCases.length;
                        completed = testCases.filter(tc => tc.branch_tag === "Completed").length;
                        pending = testCases.filter(tc => tc.branch_tag === "Pending").length;
                        onHold = testCases.filter(tc => tc.branch_tag === "On Hold").length;
                        rejected = testCases.filter(tc => tc.branch_tag === "Rejected").length;
                        doableJiras = testCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").length;
                        nonDoableJiras = totalJiras - doableJiras;
                    }

                    const row = document.createElement("tr");
                    row.dataset.id = engagement.id;
                    row.innerHTML = `
                        <td>${createdDate}</td>
                        <td class="${!jiraAssignedFilter && totalJiras === (completed + rejected) ? 'highlight-name' : ''}">${engagement.name}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'all')">${totalJiras}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Completed')">${completed}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Pending')">${pending}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'On Hold')">${onHold}</td>
                        <td class="clickable" onclick="showTestCases(${engagement.id}, 'Rejected')">${rejected}</td>
                        <td>${doableJiras}</td>
                        <td>${nonDoableJiras}</td>
                        <td>${engagement.status}</td>
                        <td>${engagement.commit_hash}</td>
                        <td>${engagement.build_id}</td>
                        <td>${usersList.find(user => user.id == engagement.lead)?.first_name || ''} ${usersList.find(user => user.id == engagement.lead)?.last_name || ''}</td>
                        <td>${engagement.version || ''}</td>
                        <td><button class="btn btn-success btn-sm" onclick="reopenEngagement(${engagement.id}, '${engagement.name}', '${engagement.target_start}', '${engagement.target_end}', '${engagement.product}', '${engagement.lead}')">Reopen</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            });

            renderPagination('closed');
        }

        function renderPagination(tab) {
            const totalPages = Math.ceil((tab === 'open' ? openEngagements : closedEngagements).length / ROWS_PER_PAGE);
            const pagination = document.getElementById(tab === 'open' ? 'pagination' : 'closedPagination');
            pagination.innerHTML = "";

            const firstItem = document.createElement("div");
            firstItem.className = `page-item ${(tab === 'open' ? currentPageOpen : currentPageClosed) === 1 ? 'active' : ''}`;
            firstItem.textContent = "First";
            firstItem.onclick = () => {
                if ((tab === 'open' ? currentPageOpen : currentPageClosed) !== 1) {
                    if (tab === 'open') currentPageOpen = 1; else currentPageClosed = 1;
                    tab === 'open' ? renderTableOpen(currentPageOpen) : renderTableClosed(currentPageClosed);
                    updatePaginationHighlight(tab);
                }
            };
            pagination.appendChild(firstItem);

            const prevItem = document.createElement("div");
            prevItem.className = `page-item`;
            prevItem.textContent = "Previous";
            prevItem.onclick = () => {
                if ((tab === 'open' ? currentPageOpen : currentPageClosed) > 1) {
                    if (tab === 'open') currentPageOpen--; else currentPageClosed--;
                    tab === 'open' ? renderTableOpen(currentPageOpen) : renderTableClosed(currentPageClosed);
                    updatePaginationHighlight(tab);
                }
            };
            pagination.appendChild(prevItem);

            const nextItem = document.createElement("div");
            nextItem.className = `page-item`;
            nextItem.textContent = "Next";
            nextItem.onclick = () => {
                if ((tab === 'open' ? currentPageOpen : currentPageClosed) < totalPages) {
                    if (tab === 'open') currentPageOpen++; else currentPageClosed++;
                    tab === 'open' ? renderTableOpen(currentPageOpen) : renderTableClosed(currentPageClosed);
                    updatePaginationHighlight(tab);
                }
            };
            pagination.appendChild(nextItem);

            const lastItem = document.createElement("div");
            lastItem.className = `page-item ${(tab === 'open' ? currentPageOpen : currentPageClosed) === totalPages ? 'active' : ''}`;
            lastItem.textContent = "Last";
            lastItem.onclick = () => {
                if ((tab === 'open' ? currentPageOpen : currentPageClosed) !== totalPages) {
                    if (tab === 'open') currentPageOpen = totalPages; else currentPageClosed = totalPages;
                    tab === 'open' ? renderTableOpen(currentPageOpen) : renderTableClosed(currentPageClosed);
                    updatePaginationHighlight(tab);
                }
            };
            pagination.appendChild(lastItem);
        }

        function updatePaginationHighlight(tab) {
            const totalPages = Math.ceil((tab === 'open' ? openEngagements : closedEngagements).length / ROWS_PER_PAGE);
            document.querySelectorAll(`#${tab === 'open' ? 'pagination' : 'closedPagination'} .page-item`).forEach(item => {
                item.classList.remove('active');
                if (item.textContent === "First" && (tab === 'open' ? currentPageOpen : currentPageClosed) === 1) item.classList.add('active');
                if (item.textContent === "Last" && (tab === 'open' ? currentPageOpen : currentPageClosed) === totalPages) item.classList.add('active');
            });
        }

        async function fetchEngagements() {
            try {
                if (debounceTimeout) clearTimeout(debounceTimeout);

                debounceTimeout = setTimeout(async () => {
                    const response = await fetch(`${BASE_URL}/engagements/?tags=crm&o=-created`);
                    const data = await response.json();
                    if (!data.results) return;

                    const date1Open = document.getElementById("date1Open").value;
                    const date2Open = document.getElementById("date2Open").value;
                    const selectedLeadOpen = document.getElementById("leadFilterOpen").value;
                    const nameSearchOpen = document.getElementById("nameSearchOpen").value.toLowerCase().trim();

                    const date1Closed = document.getElementById("date1Closed").value;
                    const date2Closed = document.getElementById("date2Closed").value;
                    const selectedLeadClosed = document.getElementById("leadFilterClosed").value;
                    const nameSearchClosed = document.getElementById("nameSearchClosed").value.toLowerCase().trim();

                    allEngagements = data.results.filter(engagement => {
                        const createdDate = engagement.created ? engagement.created.split("T")[0] : "";
                        if (!createdDate || new Date(createdDate) <= new Date("2025-02-28")) return false;
                        return true;
                    });

                    const testCasesResults = await Promise.all(
                        allEngagements.map(engagement => fetchTestCases(engagement.id))
                    );

                    allEngagements = allEngagements.map((engagement, index) => ({
                        ...engagement,
                        testCases: testCasesResults[index]
                    }));

                    openEngagements = allEngagements.filter(engagement => {
                        const isCompleted = engagement.status === "Completed" && 
                                           engagement.commit_hash === "Completed" && 
                                           engagement.build_id === "Completed";
                        return (!isCompleted || engagement.active !== false) && engagement.active === true;
                    }).filter(engagement => {
                        const createdDate = engagement.created.split("T")[0];
                        const engagementName = engagement.name.toLowerCase();
                        if (date1Open && createdDate < date1Open) return false;
                        if (date2Open && createdDate > date2Open) return false;
                        if (selectedLeadOpen && engagement.lead != selectedLeadOpen) return false;
                        if (nameSearchOpen && !engagementName.includes(nameSearchOpen)) return false;
                        return true;
                    });

                    closedEngagements = allEngagements.filter(engagement => {
                        const isCompleted = engagement.status === "Completed" && 
                                           engagement.commit_hash === "Completed" && 
                                           engagement.build_id === "Completed";
                        return (isCompleted && engagement.active === false) && engagement.active === false;
                    }).filter(engagement => {
                        const createdDate = engagement.created.split("T")[0];
                        const engagementName = engagement.name.toLowerCase();
                        if (date1Closed && createdDate < date1Closed) return false;
                        if (date2Closed && createdDate > date2Closed) return false;
                        if (selectedLeadClosed && engagement.lead != selectedLeadClosed) return false;
                        if (nameSearchClosed && !engagementName.includes(nameSearchClosed)) return false;
                        return true;
                    });

                    currentPageOpen = 1;
                    currentPageClosed = 1;
                    renderTableOpen(currentPageOpen);
                    renderTableClosed(currentPageClosed);
                    updateTotalCount();
                }, 500);
            } catch (error) {
                console.error("Error fetching engagements:", error);
                showAlert("Error fetching engagements!", "danger");
            }
        }

        async function fetchTestCases(engagementId) {
            try {
                const response = await fetch(`${BASE_URL}/tests/?engagement=${engagementId}&tags=crm_jira`);
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                console.error("Error fetching test cases:", error);
                return [];
            }
        }

        async function showTestCases(engagementId, filter) {
            currentEngagementId = engagementId;
            try {
                const response = await fetch(`${BASE_URL}/tests/?engagement=${engagementId}`);
                let data = await response.json();
                testCases = data.results || [];

                const isOpenTabActive = document.getElementById("open-tab").classList.contains("active");
                const jiraAssignedFilter = isOpenTabActive 
                    ? document.getElementById("jiraAssignedFilterOpen").value 
                    : document.getElementById("jiraAssignedFilterClosed").value;

                if (jiraAssignedFilter) {
                    testCases = testCases.filter(tc => tc.lead == jiraAssignedFilter);
                }

                if (filter !== 'all') {
                    testCases = testCases.filter(tc => tc.branch_tag === filter);
                }

                await Promise.all(testCases.map(async tc => {
                    tc.environmentName = await fetchEnvironmentName(tc.environment);
                    const lead = usersList.find(user => user.id == tc.lead);
                    tc.leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                }));

                filteredTestCases = [...testCases];
                currentTestCasesPage = 1;
                populateTestCasesFilters();
                renderTestCasesTable(currentTestCasesPage);

                const modal = document.getElementById("testCasesModal");
                const overlay = document.getElementById("modalOverlay");
                modal.style.display = "block";
                overlay.style.display = "block";
            } catch (error) {
                console.error("Error fetching test cases for modal:", error);
                showAlert("Error loading test cases!", "danger");
            }
        }

        async function showTestCasesForAnalyst(assignedTo, type, version, filter) {
            try {
                const isOpenTabActive = document.getElementById("open-tab").classList.contains("active");
                const engagements = isOpenTabActive ? openEngagements : closedEngagements;
                let allTestCases = [];
                for (const engagement of engagements) {
                    const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}`);
                    const data = await response.json();
                    allTestCases = allTestCases.concat(data.results || []);
                }

                testCases = allTestCases.filter(tc => {
                    const lead = usersList.find(user => user.id == tc.lead);
                    const leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                    return leadName === assignedTo;
                });

                const jiraAssignedFilter = isOpenTabActive 
                    ? document.getElementById("jiraAssignedFilterOpen").value 
                    : document.getElementById("jiraAssignedFilterClosed").value;

                if (jiraAssignedFilter) {
                    testCases = testCases.filter(tc => tc.lead == jiraAssignedFilter);
                }

                await Promise.all(testCases.map(async tc => {
                    tc.environmentName = await fetchEnvironmentName(tc.environment);
                }));

                testCases = testCases.filter(tc => tc.environmentName === type && (!version || tc.version === version));

                if (filter === 'Doable') {
                    testCases = testCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done");
                } else if (filter === 'Non Doable') {
                    const doable = testCases.filter(tc => tc.build_id === "Ready for Testing" || tc.build_id === "Ready for QA" || tc.build_id === "Ready for Security" || tc.build_id === "Done").map(tc => tc.id);
                    testCases = testCases.filter(tc => !doable.includes(tc.id));
                } else if (filter !== 'all') {
                    testCases = testCases.filter(tc => tc.branch_tag === filter);
                }

                await Promise.all(testCases.map(async tc => {
                    const lead = usersList.find(user => user.id == tc.lead);
                    tc.leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                }));

                filteredTestCases = [...testCases];
                currentTestCasesPage = 1;
                populateTestCasesFilters();
                renderTestCasesTable(currentTestCasesPage);

                const modal = document.getElementById("testCasesModal");
                const overlay = document.getElementById("modalOverlay");
                modal.style.display = "block";
                overlay.style.display = "block";
            } catch (error) {
                console.error("Error fetching test cases for analyst:", error);
                showAlert("Error loading test cases!", "danger");
            }
        }

        async function showAnalystView(tab) {
            try {
                const isOpenTabActive = tab === 'open';
                const engagements = isOpenTabActive ? openEngagements : closedEngagements;
                const jiraAssignedFilter = isOpenTabActive 
                    ? document.getElementById("jiraAssignedFilterOpen").value 
                    : document.getElementById("jiraAssignedFilterClosed").value;

                let allTestCases = [];
                for (const engagement of engagements) {
                    const response = await fetch(`${BASE_URL}/tests/?engagement=${engagement.id}`);
                    const data = await response.json();
                    allTestCases = allTestCases.concat(data.results || []);
                }

                if (jiraAssignedFilter) {
                    allTestCases = allTestCases.filter(tc => tc.lead == jiraAssignedFilter);
                }

                await Promise.all(allTestCases.map(async tc => {
                    tc.environmentName = await fetchEnvironmentName(tc.environment);
                    const lead = usersList.find(user => user.id == tc.lead);
                    tc.leadName = lead ? `${lead.first_name} ${lead.last_name}` : 'Unassigned';
                }));

                const analystStats = {};

                allTestCases.forEach(tc => {
                    const key = `${tc.leadName}|${tc.environmentName}|${tc.version || 'N/A'}`;
                    if (!analystStats[key]) {
                        analystStats[key] = { 
                            pending: 0, 
                            onHold: 0, 
                            completed: 0, 
                            rejected: 0, 
                            doable: 0, 
                            nonDoable: 0 
                        };
                    }
                    if (tc.branch_tag === 'Pending') analystStats[key].pending++;
                    if (tc.branch_tag === 'On Hold') analystStats[key].onHold++;
                    if (tc.branch_tag === 'Completed') analystStats[key].completed++;
                    if (tc.branch_tag === 'Rejected') analystStats[key].rejected++;
                    if (tc.build_id === 'Ready for Testing' || tc.build_id === 'Ready for QA' || tc.build_id === 'Ready for Security' || tc.build_id === 'Done') analystStats[key].doable++;
                    else analystStats[key].nonDoable++;
                });

                // Store data for filtering
                analystData = Object.keys(analystStats).map(key => {
                    const [assignedTo, type, version] = key.split('|');
                    return { assignedTo, type, version, ...analystStats[key] };
                }).filter(stats => 
                    stats.pending || stats.onHold || stats.completed || stats.rejected || stats.doable || stats.nonDoable
                );

                populateAnalystFilters();
                renderAnalystTable();

                const modal = document.getElementById("analystViewModal");
                const overlay = document.getElementById("modalOverlay");
                modal.style.display = "block";
                overlay.style.display = "block";
            } catch (error) {
                console.error("Error showing analyst view:", error);
                showAlert("Error loading analyst view!", "danger");
            }
        }

        function populateAnalystFilters() {
            const assignedToFilter = document.getElementById("analystAssignedToFilter");
            const typeFilter = document.getElementById("analystTypeFilter");
            const versionFilter = document.getElementById("analystVersionFilter");

            const uniqueAssignedTos = [...new Set(analystData.map(data => data.assignedTo))].sort();
            const uniqueTypes = [...new Set(analystData.map(data => data.type))].sort();
            const uniqueVersions = [...new Set(analystData.map(data => data.version))].sort();

            assignedToFilter.innerHTML = '<option value="">Filter by Assigned To</option>' + 
                uniqueAssignedTos.map(val => `<option value="${val}">${val}</option>`).join('');
            typeFilter.innerHTML = '<option value="">Filter by Type</option>' + 
                uniqueTypes.map(val => `<option value="${val}">${val}</option>`).join('');
            versionFilter.innerHTML = '<option value="">Filter by Version</option>' + 
                uniqueVersions.map(val => `<option value="${val}">${val}</option>`).join('');
        }

        function applyAnalystFilters() {
            renderAnalystTable();
        }

        function clearAnalystFilters() {
            document.getElementById("analystAssignedToFilter").value = "";
            document.getElementById("analystTypeFilter").value = "";
            document.getElementById("analystVersionFilter").value = "";
            renderAnalystTable();
        }

        function renderAnalystTable() {
            const analystTableBody = document.getElementById("analystTableBody");
            analystTableBody.innerHTML = '';

            const assignedToFilter = document.getElementById("analystAssignedToFilter").value;
            const typeFilter = document.getElementById("analystTypeFilter").value;
            const versionFilter = document.getElementById("analystVersionFilter").value;

            let filteredData = analystData.filter(data => 
                (!assignedToFilter || data.assignedTo === assignedToFilter) &&
                (!typeFilter || data.type === typeFilter) &&
                (!versionFilter || data.version === versionFilter)
            );

            filteredData.forEach(stats => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${stats.assignedTo}</td>
                    <td>${stats.type}</td>
                    <td>${stats.version}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'Pending')">${stats.pending}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'On Hold')">${stats.onHold}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'Completed')">${stats.completed}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'Rejected')">${stats.rejected}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'Doable')">${stats.doable}</td>
                    <td class="clickable" onclick="showTestCasesForAnalyst('${stats.assignedTo}', '${stats.type}', '${stats.version}', 'Non Doable')">${stats.nonDoable}</td>
                `;
                analystTableBody.appendChild(row);
            });

            // Add Total row
            const totalRow = document.createElement("tr");
            totalRow.className = "total-row";
            const totals = {
                pending: filteredData.reduce((sum, data) => sum + data.pending, 0),
                onHold: filteredData.reduce((sum, data) => sum + data.onHold, 0),
                completed: filteredData.reduce((sum, data) => sum + data.completed, 0),
                rejected: filteredData.reduce((sum, data) => sum + data.rejected, 0),
                doable: filteredData.reduce((sum, data) => sum + data.doable, 0),
                nonDoable: filteredData.reduce((sum, data) => sum + data.nonDoable, 0)
            };
            totalRow.innerHTML = `
                <td>Total</td>
                <td>-</td>
                <td>-</td>
                <td>${totals.pending}</td>
                <td>${totals.onHold}</td>
                <td>${totals.completed}</td>
                <td>${totals.rejected}</td>
                <td>${totals.doable}</td>
                <td>${totals.nonDoable}</td>
            `;
            analystTableBody.appendChild(totalRow);
        }

        function closeAnalystViewModal() {
            const modal = document.getElementById("analystViewModal");
            const overlay = document.getElementById("modalOverlay");
            modal.style.display = "none";
            overlay.style.display = "none";
            analystData = []; // Clear data when closing
        }

        function populateTestCasesFilters() {
            const typeFilter = document.getElementById("filterType");
            const issueTypeFilter = document.getElementById("filterIssueType");
            const jiraStatusFilter = document.getElementById("filterJiraStatus");
            const statusFilter = document.getElementById("filterStatus");
            const assignedToFilter = document.getElementById("filterAssignedTo");

            const uniqueTypes = [...new Set(testCases.map(tc => tc.environmentName || 'N/A'))].sort();
            const uniqueIssueTypes = [...new Set(testCases.map(tc => tc.commit_hash || 'N/A'))].sort();
            const uniqueJiraStatuses = [...new Set(testCases.map(tc => tc.build_id || 'N/A'))].sort();
            const uniqueStatuses = [...new Set(testCases.map(tc => tc.branch_tag || 'N/A'))].sort();
            const uniqueAssignedTos = [...new Set(testCases.map(tc => tc.leadName || 'Unassigned'))].sort();

            typeFilter.innerHTML = '<option value="">Filter by Type</option>' + uniqueTypes.map(val => `<option value="${val}">${val}</option>`).join('');
            issueTypeFilter.innerHTML = '<option value="">Filter by Issue Type</option>' + uniqueIssueTypes.map(val => `<option value="${val}">${val}</option>`).join('');
            jiraStatusFilter.innerHTML = '<option value="">Filter by Jira Status</option>' + uniqueJiraStatuses.map(val => `<option value="${val}">${val}</option>`).join('');
            statusFilter.innerHTML = '<option value="">Filter by Status</option>' + uniqueStatuses.map(val => `<option value="${val}">${val}</option>`).join('');
            assignedToFilter.innerHTML = '<option value="">Filter by Assigned To</option>' + uniqueAssignedTos.map(val => `<option value="${val}">${val}</option>`).join('');
        }

        function applyTestCasesFilters() {
            const typeFilter = document.getElementById("filterType").value;
            const issueTypeFilter = document.getElementById("filterIssueType").value;
            const jiraStatusFilter = document.getElementById("filterJiraStatus").value;
            const statusFilter = document.getElementById("filterStatus").value;
            const assignedToFilter = document.getElementById("filterAssignedTo").value;

            filteredTestCases = testCases.filter(tc => {
                return (!typeFilter || tc.environmentName === typeFilter) &&
                       (!issueTypeFilter || tc.commit_hash === issueTypeFilter) &&
                       (!jiraStatusFilter || tc.build_id === jiraStatusFilter) &&
                       (!statusFilter || tc.branch_tag === statusFilter) &&
                       (!assignedToFilter || tc.leadName === assignedToFilter);
            });

            currentTestCasesPage = 1;
            renderTestCasesTable(currentTestCasesPage);
        }

        function createTestCaseStatusDropdown(selectedValue) {
            const options = ["Pending", "On Hold", "Completed", "Rejected"];
            let dropdown = `<select class="form-select status-dropdown">`;
            options.forEach(option => {
                dropdown += `<option value="${option}" ${option === selectedValue ? "selected" : ""}>${option}</option>`;
            });
            dropdown += `</select>`;
            return dropdown;
        }

        function renderTestCasesTable(page) {
            const tableBody = document.getElementById("testCasesTableBody");
            tableBody.innerHTML = "";
            const start = (page - 1) * TEST_CASES_PER_PAGE;
            const end = start + TEST_CASES_PER_PAGE;
            const paginatedTestCases = filteredTestCases.slice(start, end);

            document.getElementById("testCasesCount").textContent = `Total Test Cases: ${filteredTestCases.length}`;

            requestAnimationFrame(() => {
                paginatedTestCases.forEach(tc => {
                    const row = document.createElement("tr");
                    row.dataset.id = tc.id;
                    row.innerHTML = `
                        <td>${tc.id}</td>
                        <td>${tc.title || ''}</td>
                        <td>${tc.description || ''}</td>
                        <td>${tc.version || ''}</td>
                        <td>${createTestCaseStatusDropdown(tc.branch_tag || 'Pending')}</td>
                        <td>${tc.leadName}</td>
                        <td>${tc.environmentName || 'N/A'}</td>
                        <td>${tc.commit_hash || 'N/A'}</td>
                        <td>${tc.build_id || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);

                    const statusDropdown = row.querySelector(".status-dropdown");
                    statusDropdown.addEventListener("change", async () => {
                        await updateTestCase(tc.id, tc.title, statusDropdown.value);
                        renderTestCasesTable(currentTestCasesPage);
                    });
                    statusDropdown.addEventListener("blur", () => {
                        showAlert("saved", "success", tc.title || `Test Case ${tc.id}`);
                    });
                });
            });

            renderTestCasesPagination();
        }

        async function updateTestCase(testId, title, newStatus) {
            try {
                const payload = {
                    branch_tag: newStatus
                };
                const response = await fetch(`${BASE_URL}/tests/${testId}/`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                    body: JSON.stringify(payload),
                    credentials: "include"
                });

                if (response.ok) {
                    const updatedTestCase = await response.json();
                    testCases = testCases.map(tc => tc.id === testId ? { ...tc, branch_tag: updatedTestCase.branch_tag } : tc);
                    filteredTestCases = filteredTestCases.map(tc => tc.id === testId ? { ...tc, branch_tag: updatedTestCase.branch_tag } : tc);
                    fetchEngagements();
                } else {
                    showAlert("Failed to update test case!", "danger");
                }
            } catch (error) {
                showAlert("Error updating test case!", "danger");
                console.error("Error:", error);
            }
        }

        function renderTestCasesPagination() {
            const totalPages = Math.ceil(filteredTestCases.length / TEST_CASES_PER_PAGE);
            const pagination = document.getElementById("testCasesPagination");
            pagination.innerHTML = "";

            const firstItem = document.createElement("div");
            firstItem.className = `page-item ${currentTestCasesPage === 1 ? 'active' : ''}`;
            firstItem.textContent = "First";
            firstItem.onclick = () => {
                if (currentTestCasesPage !== 1) {
                    currentTestCasesPage = 1;
                    renderTestCasesTable(currentTestCasesPage);
                    updateTestCasesPaginationHighlight();
                }
            };
            pagination.appendChild(firstItem);

            const prevItem = document.createElement("div");
            prevItem.className = "page-item";
            prevItem.textContent = "Previous";
            prevItem.onclick = () => {
                if (currentTestCasesPage > 1) {
                    currentTestCasesPage--;
                    renderTestCasesTable(currentTestCasesPage);
                    updateTestCasesPaginationHighlight();
                }
            };
            pagination.appendChild(prevItem);

            const nextItem = document.createElement("div");
            nextItem.className = "page-item";
            nextItem.textContent = "Next";
            nextItem.onclick = () => {
                if (currentTestCasesPage < totalPages) {
                    currentTestCasesPage++;
                    renderTestCasesTable(currentTestCasesPage);
                    updateTestCasesPaginationHighlight();
                }
            };
            pagination.appendChild(nextItem);

            const lastItem = document.createElement("div");
            lastItem.className = `page-item ${currentTestCasesPage === totalPages ? 'active' : ''}`;
            lastItem.textContent = "Last";
            lastItem.onclick = () => {
                if (currentTestCasesPage !== totalPages) {
                    currentTestCasesPage = totalPages;
                    renderTestCasesTable(currentTestCasesPage);
                    updateTestCasesPaginationHighlight();
                }
            };
            pagination.appendChild(lastItem);
        }

        function updateTestCasesPaginationHighlight() {
            const totalPages = Math.ceil(filteredTestCases.length / TEST_CASES_PER_PAGE);
            document.querySelectorAll("#testCasesPagination .page-item").forEach(item => {
                item.classList.remove('active');
                if (item.textContent === "First" && currentTestCasesPage === 1) item.classList.add('active');
                if (item.textContent === "Last" && currentTestCasesPage === totalPages) item.classList.add('active');
            });
        }

        function closeTestCasesModal() {
            const modal = document.getElementById("testCasesModal");
            const overlay = document.getElementById("modalOverlay");
            modal.style.display = "none";
            overlay.style.display = "none";
            currentEngagementId = null;
        }

        function createDropdown(selectedValue) {
            const options = ["Not Started", "On Hold", "Completed"];
            let dropdown = `<select class="form-select status-dropdown">`;
            options.forEach(option => {
                dropdown += `<option value="${option}" ${option === selectedValue ? "selected" : ""}>${option}</option>`;
            });
            dropdown += `</select>`;
            return dropdown;
        }

        function createLeadDropdown(selectedLeadId) {
            let dropdown = `<select class="form-select lead-dropdown">`;
            usersList.forEach(user => {
                dropdown += `<option value="${user.id}" ${user.id == selectedLeadId ? "selected" : ""}>${user.first_name} ${user.last_name}</option>`;
            });
            dropdown += `</select>`;
            return dropdown;
        }

        async function updateEngagement(engagementId, name, targetStart, targetEnd, product, lead) {
            try {
                const row = document.querySelector(`tr[data-id="${engagementId}"]`);
                if (!row || !document.getElementById("open-tab").classList.contains("active")) {
                    console.error("Update called outside Open SCT tab or row not found");
                    return;
                }

                const status = row.querySelector("td:nth-child(10) select").value;
                const commitHash = row.querySelector("td:nth-child(11) select").value;
                const buildId = row.querySelector("td:nth-child(12) select").value;
                const version = row.querySelector(".version-input").value;
                const updatedLead = row.querySelector(".lead-dropdown").value;

                const isCompleted = status === "Completed" && commitHash === "Completed" && buildId === "Completed";
                console.log(`Engagement ${engagementId} - Status: ${status}, Commit Hash: ${commitHash}, Build ID: ${buildId}, Is Completed: ${isCompleted}`);

                const payload = {
                    id: engagementId,
                    name,
                    target_start: targetStart,
                    target_end: targetEnd,
                    product,
                    lead: updatedLead,
                    status,
                    commit_hash: commitHash,
                    build_id: buildId,
                    version,
                    active: isCompleted ? false : true
                };

                console.log("Sending payload:", payload);

                const response = await fetch(`${BASE_URL}/engagements/${engagementId}/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                    body: JSON.stringify(payload),
                    credentials: "include"
                });

                if (response.ok) {
                    if (event && event.type === "click") {
                        showAlert("saved successfully", "success", name);
                    }
                } else {
                    showAlert("Failed to update engagement!", "danger");
                }

                fetchEngagements();
            } catch (error) {
                showAlert("Error updating engagement!", "danger");
                console.error("Error:", error);
            }
        }

        async function closeEngagement(engagementId, name, targetStart, targetEnd, product, lead) {
            try {
                fetch(`https://demo.defectdojo.org/engagement/${engagementId}/close`, {
                    method: "GET",
                    credentials: "include"
                }).catch(error => console.error("Background URL fetch failed:", error));

                showModal(name);

                const getResponse = await fetch(`${BASE_URL}/engagements/${engagementId}/`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                if (!getResponse.ok) {
                    showAlert("Failed to fetch engagement data!", "danger");
                    return;
                }

                const engagementData = await getResponse.json();

                const payload = {
                    id: engagementId,
                    name: engagementData.name,
                    target_start: engagementData.target_start,
                    target_end: engagementData.target_end,
                    active: false,
                    status: engagementData.status || "Completed",
                    lead: engagementData.lead,
                    product: engagementData.product
                };

                console.log("Closing payload:", payload);

                const putResponse = await fetch(`${BASE_URL}/engagements/${engagementId}/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                    body: JSON.stringify(payload),
                    credentials: "include"
                });

                if (putResponse.ok) {
                    fetchEngagements();
                } else {
                    showAlert("Failed to close engagement!", "danger");
                }
            } catch (error) {
                showAlert("Error closing engagement!", "danger");
                console.error("Error:", error);
            }
        }

        async function reopenEngagement(engagementId, name, targetStart, targetEnd, product, lead) {
            try {
                fetch(`https://demo.defectdojo.org/engagement/${engagementId}/reopen`, {
                    method: "GET",
                    credentials: "include"
                }).catch(error => console.error("Background URL fetch failed:", error));

                showModal(name, true);

                const getResponse = await fetch(`${BASE_URL}/engagements/${engagementId}/`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                if (!getResponse.ok) {
                    showAlert("Failed to fetch engagement data!", "danger");
                    return;
                }

                const engagementData = await getResponse.json();

                const payload = {
                    id: engagementId,
                    name: engagementData.name,
                    target_start: engagementData.target_start,
                    target_end: engagementData.target_end,
                    active: true,
                    status: "Not Started",
                    lead: engagementData.lead,
                    product: engagementData.product
                };

                console.log("Reopening payload:", payload);

                const putResponse = await fetch(`${BASE_URL}/engagements/${engagementId}/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                    body: JSON.stringify(payload),
                    credentials: "include"
                });

                if (putResponse.ok) {
                    fetchEngagements();
                } else {
                    showAlert("Failed to reopen engagement!", "danger");
                }
            } catch (error) {
                showAlert("Error reopening engagement!", "danger");
                console.error("Error:", error);
            }
        }
		
		function showCreateSCTModal() {
    const modal = document.getElementById("createSCTModal");
    const overlay = document.getElementById("modalOverlay");
    document.getElementById("engagementNames").value = '';
    document.getElementById("createSummary").style.display = 'none';
    modal.style.display = "block";
    overlay.style.display = "block";
}

function closeCreateSCTModal() {
    const modal = document.getElementById("createSCTModal");
    const overlay = document.getElementById("modalOverlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}

async function createEngagements() {
    const namesInput = document.getElementById("engagementNames").value.trim();
    if (!namesInput) {
        showAlert("Please enter at least one engagement name!", "danger");
        return;
    }

    const names = namesInput.split(',').map(name => name.trim()).filter(name => name);
    const today = new Date().toISOString().split('T')[0];
    const created = [];
    const skipped = [];
    const errors = [];

    // Check existing engagements
    const existingNames = new Set(allEngagements.map(eng => eng.name.toLowerCase()));

    for (const name of names) {
        if (existingNames.has(name.toLowerCase())) {
            skipped.push(name);
            continue;
        }

        const payload = {
            name: name,
            target_start: today,
            target_end: today,
            lead: 2,
            status: "Not Started",
            tags: ["crm"],
            product: 3,
            active: true
        };

        try {
            const response = await fetch(`${BASE_URL}/engagements/`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "X-CSRFToken": csrfToken 
                },
                body: JSON.stringify(payload),
                credentials: "include"
            });

            if (response.ok) {
                const data = await response.json();
                created.push({ id: data.id, name: data.name });
                existingNames.add(name.toLowerCase()); // Add to prevent duplicates in this batch
            } else {
                errors.push(name);
            }
        } catch (error) {
            console.error(`Error creating engagement ${name}:`, error);
            errors.push(name);
        }
    }

    // Render summary
    const createdTableBody = document.getElementById("createdTableBody");
    const skippedTableBody = document.getElementById("skippedTableBody");
    const errorTableBody = document.getElementById("errorTableBody");

    createdTableBody.innerHTML = created.map(item => `
        <tr>
            <td>${item.id}</td>
            <td>${item.name}</td>
        </tr>
    `).join('') || '<tr><td colspan="2">None</td></tr>';

    skippedTableBody.innerHTML = skipped.map(name => `
        <tr>
            <td>${name}</td>
        </tr>
    `).join('') || '<tr><td>None</td></tr>';

    errorTableBody.innerHTML = errors.map(name => `
        <tr>
            <td>${name}</td>
        </tr>
    `).join('') || '<tr><td>None</td></tr>';

    document.getElementById("createSummary").style.display = 'block';

    if (created.length > 0) {
        fetchEngagements(); // Refresh the main table
        showAlert(`${created.length} engagement(s) created successfully!`, "success");
    }
    if (errors.length > 0) {
        showAlert(`${errors.length} engagement(s) failed to create!`, "danger");
    }
}
















        document.addEventListener("DOMContentLoaded", async () => {
            await fetchCSRF();
            await fetchUsers();
            await fetchEngagements();
        });
    </script>
</body>
</html>